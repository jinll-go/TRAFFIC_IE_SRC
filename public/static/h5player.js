!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.CVH5Lib=t():e.CVH5Lib=t()}(this,(function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(i,s,function(t){return e[t]}.bind(null,s));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=36)}([function(e,t,r){"use strict";var i,s,n,a,o,l,c,h=r(7),d=r(24),u=Function.prototype.apply,_=Function.prototype.call,f=Object.create,m=Object.defineProperty,p=Object.defineProperties,g=Object.prototype.hasOwnProperty,v={configurable:!0,enumerable:!1,writable:!0};s=function(e,t){var r,s;return d(t),s=this,i.call(this,e,r=function(){n.call(s,e,r),u.call(t,this,arguments)}),r.__eeOnceListener__=t,this},o={on:i=function(e,t){var r;return d(t),g.call(this,"__ee__")?r=this.__ee__:(r=v.value=f(null),m(this,"__ee__",v),v.value=null),r[e]?"object"==typeof r[e]?r[e].push(t):r[e]=[r[e],t]:r[e]=t,this},once:s,off:n=function(e,t){var r,i,s,n;if(d(t),!g.call(this,"__ee__"))return this;if(!(r=this.__ee__)[e])return this;if("object"==typeof(i=r[e]))for(n=0;s=i[n];++n)s!==t&&s.__eeOnceListener__!==t||(2===i.length?r[e]=i[n?0:1]:i.splice(n,1));else i!==t&&i.__eeOnceListener__!==t||delete r[e];return this},emit:a=function(e){var t,r,i,s,n;if(g.call(this,"__ee__")&&(s=this.__ee__[e]))if("object"==typeof s){for(r=arguments.length,n=new Array(r-1),t=1;t<r;++t)n[t-1]=arguments[t];for(s=s.slice(),t=0;i=s[t];++t)u.call(i,this,n)}else switch(arguments.length){case 1:_.call(s,this);break;case 2:_.call(s,this,arguments[1]);break;case 3:_.call(s,this,arguments[1],arguments[2]);break;default:for(r=arguments.length,n=new Array(r-1),t=1;t<r;++t)n[t-1]=arguments[t];u.call(s,this,n)}}},l={on:h(i),once:h(s),off:h(n),emit:h(a)},c=p({},l),e.exports=t=function(e){return null==e?f(c):p(Object(e),l)},t.methods=o},function(e,t,r){"use strict";var i=r(18)();e.exports=function(e){return e!==i&&null!==e}},function(e,t){e.exports=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}},function(e,t,r){"use strict";e.exports=function(e){return null!=e}},function(e,t,r){var i=r(27),s="object"==typeof self&&self&&self.Object===Object&&self,n=i||s||Function("return this")();e.exports=n},function(e,t,r){var i=r(4).Symbol;e.exports=i},function(e,t,r){var i=r(25),s=r(2);e.exports=function(e,t,r){var n=!0,a=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return s(r)&&(n="leading"in r?!!r.leading:n,a="trailing"in r?!!r.trailing:a),i(e,t,{leading:n,maxWait:t,trailing:a})}},function(e,t,r){"use strict";var i=r(3),s=r(8),n=r(12),a=r(20),o=r(21);(e.exports=function(e,t){var r,s,l,c,h;return arguments.length<2||"string"!=typeof e?(c=t,t=e,e=null):c=arguments[2],i(e)?(r=o.call(e,"c"),s=o.call(e,"e"),l=o.call(e,"w")):(r=l=!0,s=!1),h={value:t,configurable:r,enumerable:s,writable:l},c?n(a(c),h):h}).gs=function(e,t,r){var l,c,h,d;return"string"!=typeof e?(h=r,r=t,t=e,e=null):h=arguments[3],i(t)?s(t)?i(r)?s(r)||(h=r,r=void 0):r=void 0:(h=t,t=r=void 0):t=void 0,i(e)?(l=o.call(e,"c"),c=o.call(e,"e")):(l=!0,c=!1),d={get:t,set:r,configurable:l,enumerable:c},h?n(a(h),d):d}},function(e,t,r){"use strict";var i=r(9),s=/^\s*class[\s{/}]/,n=Function.prototype.toString;e.exports=function(e){return!!i(e)&&!s.test(n.call(e))}},function(e,t,r){"use strict";var i=r(10);e.exports=function(e){if("function"!=typeof e)return!1;if(!hasOwnProperty.call(e,"length"))return!1;try{if("number"!=typeof e.length)return!1;if("function"!=typeof e.call)return!1;if("function"!=typeof e.apply)return!1}catch(e){return!1}return!i(e)}},function(e,t,r){"use strict";var i=r(11);e.exports=function(e){if(!i(e))return!1;try{return!!e.constructor&&e.constructor.prototype===e}catch(e){return!1}}},function(e,t,r){"use strict";var i=r(3),s={object:!0,function:!0,undefined:!0};e.exports=function(e){return!!i(e)&&hasOwnProperty.call(s,typeof e)}},function(e,t,r){"use strict";e.exports=r(13)()?Object.assign:r(14)},function(e,t,r){"use strict";e.exports=function(){var e,t=Object.assign;return"function"==typeof t&&(t(e={foo:"raz"},{bar:"dwa"},{trzy:"trzy"}),e.foo+e.bar+e.trzy==="razdwatrzy")}},function(e,t,r){"use strict";var i=r(15),s=r(19),n=Math.max;e.exports=function(e,t){var r,a,o,l=n(arguments.length,2);for(e=Object(s(e)),o=function(i){try{e[i]=t[i]}catch(e){r||(r=e)}},a=1;a<l;++a)i(t=arguments[a]).forEach(o);if(void 0!==r)throw r;return e}},function(e,t,r){"use strict";e.exports=r(16)()?Object.keys:r(17)},function(e,t,r){"use strict";e.exports=function(){try{return Object.keys("primitive"),!0}catch(e){return!1}}},function(e,t,r){"use strict";var i=r(1),s=Object.keys;e.exports=function(e){return s(i(e)?Object(e):e)}},function(e,t,r){"use strict";e.exports=function(){}},function(e,t,r){"use strict";var i=r(1);e.exports=function(e){if(!i(e))throw new TypeError("Cannot use null or undefined");return e}},function(e,t,r){"use strict";var i=r(1),s=Array.prototype.forEach,n=Object.create,a=function(e,t){var r;for(r in e)t[r]=e[r]};e.exports=function(e){var t=n(null);return s.call(arguments,(function(e){i(e)&&a(Object(e),t)})),t}},function(e,t,r){"use strict";e.exports=r(22)()?String.prototype.contains:r(23)},function(e,t,r){"use strict";var i="razdwatrzy";e.exports=function(){return"function"==typeof i.contains&&(!0===i.contains("dwa")&&!1===i.contains("foo"))}},function(e,t,r){"use strict";var i=String.prototype.indexOf;e.exports=function(e){return i.call(this,e,arguments[1])>-1}},function(e,t,r){"use strict";e.exports=function(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");return e}},function(e,t,r){var i=r(2),s=r(26),n=r(29),a=Math.max,o=Math.min;e.exports=function(e,t,r){var l,c,h,d,u,_,f=0,m=!1,p=!1,g=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function v(t){var r=l,i=c;return l=c=void 0,f=t,d=e.apply(i,r)}function y(e){return f=e,u=setTimeout(b,t),m?v(e):d}function w(e){var r=e-_;return void 0===_||r>=t||r<0||p&&e-f>=h}function b(){var e=s();if(w(e))return R(e);u=setTimeout(b,function(e){var r=t-(e-_);return p?o(r,h-(e-f)):r}(e))}function R(e){return u=void 0,g&&l?v(e):(l=c=void 0,d)}function E(){var e=s(),r=w(e);if(l=arguments,c=this,_=e,r){if(void 0===u)return y(_);if(p)return clearTimeout(u),u=setTimeout(b,t),v(_)}return void 0===u&&(u=setTimeout(b,t)),d}return t=n(t)||0,i(r)&&(m=!!r.leading,h=(p="maxWait"in r)?a(n(r.maxWait)||0,t):h,g="trailing"in r?!!r.trailing:g),E.cancel=function(){void 0!==u&&clearTimeout(u),f=0,l=_=c=u=void 0},E.flush=function(){return void 0===u?d:R(s())},E}},function(e,t,r){var i=r(4);e.exports=function(){return i.Date.now()}},function(e,t,r){(function(t){var r="object"==typeof t&&t&&t.Object===Object&&t;e.exports=r}).call(this,r(28))},function(e,t){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"==typeof window&&(r=window)}e.exports=r},function(e,t,r){var i=r(2),s=r(30),n=/^\s+|\s+$/g,a=/^[-+]0x[0-9a-f]+$/i,o=/^0b[01]+$/i,l=/^0o[0-7]+$/i,c=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(s(e))return NaN;if(i(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=i(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(n,"");var r=o.test(e);return r||l.test(e)?c(e.slice(2),r?2:8):a.test(e)?NaN:+e}},function(e,t,r){var i=r(31),s=r(34);e.exports=function(e){return"symbol"==typeof e||s(e)&&"[object Symbol]"==i(e)}},function(e,t,r){var i=r(5),s=r(32),n=r(33),a=i?i.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":a&&a in Object(e)?s(e):n(e)}},function(e,t,r){var i=r(5),s=Object.prototype,n=s.hasOwnProperty,a=s.toString,o=i?i.toStringTag:void 0;e.exports=function(e){var t=n.call(e,o),r=e[o];try{e[o]=void 0;var i=!0}catch(e){}var s=a.call(e);return i&&(t?e[o]=r:delete e[o]),s}},function(e,t){var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},function(e,t){e.exports=function(e){return null!=e&&"object"==typeof e}},function(e,t,r){var i;!function(e){"use strict";var t=function(){},r=function(e){return new a(e)};r.IsOpen=function(){var e=r.Stream;if(e){var t=(e.getTracks&&e.getTracks()||e.audioTracks||[])[0];if(t){var i=t.readyState;return"live"==i||i==t.LIVE}}return!1},r.BufferSize=4096,r.Destroy=function(){for(var e in s("Recorder Destroy"),i)i[e]()};var i={};r.BindDestroy=function(e,t){i[e]=t},r.Support=function(){var t=e.AudioContext;if(t||(t=e.webkitAudioContext),!t)return!1;var i=navigator.mediaDevices||{};return i.getUserMedia||(i=navigator).getUserMedia||(i.getUserMedia=i.webkitGetUserMedia||i.mozGetUserMedia||i.msGetUserMedia),!!i.getUserMedia&&(r.Scope=i,r.Ctx&&"closed"!=r.Ctx.state||(r.Ctx=new t,r.BindDestroy("Ctx",(function(){var e=r.Ctx;e&&e.close&&e.close()}))),!0)},r.SampleData=function(e,t,r,i,s){i||(i={});var n=i.index||0,a=i.offset||0,o=i.frameNext||[];s||(s={});var l=s.frameSize||1;s.frameType&&(l="mp3"==s.frameType?1152:1);for(var c=0,h=n;h<e.length;h++)c+=e[h].length;c=Math.max(0,c-Math.floor(a));var d=t/r;1<d?c=Math.floor(c/d):(d=1,r=t),c+=o.length;var u=new Int16Array(c),_=0;for(h=0;h<o.length;h++)u[_]=o[h],_++;for(var f=e.length;n<f;n++){for(var m=e[n],p=(h=a,m.length);h<p;){var g=Math.floor(h),v=Math.ceil(h),y=h-g;u[_]=m[g]+(m[v]-m[g])*y,_++,h+=d}a=h-p}o=null;var w=u.length%l;if(0<w){var b=2*(u.length-w);o=new Int16Array(u.buffer.slice(b)),u=new Int16Array(u.buffer.slice(0,b))}return{index:n,offset:a,frameNext:o,sampleRate:r,data:u}},r.PowerLevel=function(e,t){var r=e/t||0;return r<1251?Math.round(r/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(r/1e4)/Math.log(10)))))};var s=function(e,t){var r=new Date,i=("0"+r.getMinutes()).substr(-2)+":"+("0"+r.getSeconds()).substr(-2)+"."+("00"+r.getMilliseconds()).substr(-3),s=["["+i+" Recorder]"+e],n=arguments,a=2,o=console.log;for("number"==typeof t?o=1==t?console.error:3==t?console.warn:o:a=1;a<n.length;a++)s.push(n[a]);o.apply(console,s)};r.CLog=s;var n=0;function a(e){this.id=++n,r.Traffic&&r.Traffic();var i={type:"mp3",bitRate:16,sampleRate:16e3,onProcess:t};for(var s in e)i[s]=e[s];this.set=i,this._S=9}r.Sync={O:9,C:9},r.prototype=a.prototype={open:function(i,n){var a=this;i=i||t;var o=function(e,t){s("录音open失败："+e+",isUserNotAllow:"+(t=!!t),1),n&&n(e,t)},l=function(){s("open成功"),i(),a._SO=0},c=function(t,r){try{e.top.a}catch(t){return void o('无权录音(跨域，请尝试给iframe添加麦克风访问策略，如allow="camera;microphone")')}/Permission|Allow/i.test(t)?o("用户拒绝了录音权限",!0):!1===e.isSecureContext?o("无权录音(需https)"):/Found/i.test(t)?o(r+"，无可用麦克风"):o(r)},h=r.Sync,d=++h.O,u=h.C;a._O=a._O_=d,a._SO=a._S;var _=function(){if(u!=h.C||!a._O){var e="open被取消";return d==h.O?a.close():e="open被中断",o(e),!0}};if(r.IsOpen())l();else if(r.Support()){var f=a.envCheck({envName:"H5",canProcess:!0});if(f)o("不能录音："+f);else{var m=function(e){(r.Stream=e)._call={},_()||setTimeout((function(){_()||(r.IsOpen()?(function(){var e=r.Ctx,t=r.Stream,i=t._m=e.createMediaStreamSource(t),s=t._p=(e.createScriptProcessor||e.createJavaScriptNode).call(e,r.BufferSize,1,1);i.connect(s),s.connect(e.destination);var n=t._call;s.onaudioprocess=function(e){for(var t in n){for(var r=e.inputBuffer.getChannelData(0),i=r.length,s=new Int16Array(i),a=0,o=0;o<i;o++){var l=Math.max(-1,Math.min(1,r[o]));l=l<0?32768*l:32767*l,s[o]=l,a+=Math.abs(l)}for(var c in n)n[c](s,a);return}}}(),l()):o("录音功能无效：无音频流"))}),100)},p=function(e){var t=e.name||e.message||e.code+":"+e;s("请求录音权限错误",1,e),c(t,"无法录音："+t)},g=r.Scope.getUserMedia({audio:!0},m,p);g&&g.then&&g.then(m)[i&&"catch"](p)}}else c("","此浏览器不支持录音")},close:function(e){e=e||t,this._stop();var i=r.Sync;if(this._O=0,this._O_!=i.O)return s("close被忽略",3),void e();i.C++;var n,a=r.Stream;if(a){(n=r.Stream)._m&&(n._m.disconnect(),n._p.disconnect(),n._p.onaudioprocess=n._p=n._m=null);for(var o=a.getTracks&&a.getTracks()||a.audioTracks||[],l=0;l<o.length;l++){var c=o[l];c.stop&&c.stop()}a.stop&&a.stop()}r.Stream=0,s("close"),e()},mock:function(e,t){var r=this;return r._stop(),r.isMock=1,r.mockEnvInfo=null,r.buffers=[e],r.recSize=e.length,r.srcSampleRate=t,r},envCheck:function(e){var t,r=this.set;return t||(this[r.type+"_envCheck"]?t=this[r.type+"_envCheck"](e,r):r.takeoffEncodeChunk&&(t=r.type+"类型不支持设置takeoffEncodeChunk")),t||""},envStart:function(e,t){var r=this,i=r.set;if(r.isMock=e?1:0,r.mockEnvInfo=e,r.buffers=[],r.recSize=0,r.envInLast=0,r.envInFirst=0,r.envInFix=0,r.envInFixTs=[],i.sampleRate=Math.min(t,i.sampleRate),r.srcSampleRate=t,r.engineCtx=0,r[i.type+"_start"]){var s=r.engineCtx=r[i.type+"_start"](i);s&&(s.pcmDatas=[],s.pcmSize=0)}},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){var i=this,n=i.set,a=i.engineCtx,o=i.srcSampleRate,l=e.length,c=r.PowerLevel(t,l),h=i.buffers,d=h.length;h.push(e);var u=h,_=d,f=Date.now(),m=Math.round(l/o*1e3);i.envInLast=f,1==i.buffers.length&&(i.envInFirst=f-m);var p=i.envInFixTs;p.splice(0,0,{t:f,d:m});for(var g=f,v=0,y=0;y<p.length;y++){var w=p[y];if(3e3<f-w.t){p.length=y;break}g=w.t,v+=w.d}var b=p[1],R=f-g;if(R/3<R-v&&(b&&1e3<R||6<=p.length)){var E=f-b.t-m;if(m/5<E){var U=!n.disableEnvInFix;if(s("["+f+"]"+(U?"":"未")+"补偿"+E+"ms",3),i.envInFix+=E,U){var x=new Int16Array(E*o/1e3);l+=x.length,h.push(x)}}}var A=i.recSize,O=l,S=A+O;if(i.recSize=S,a){var T=r.SampleData(h,o,n.sampleRate,a.chunkInfo);a.chunkInfo=T,S=(A=a.pcmSize)+(O=T.data.length),a.pcmSize=S,h=a.pcmDatas,d=h.length,h.push(T.data),o=T.sampleRate}var D=Math.round(S/o*1e3),k=h.length,C=u.length,L=function(){for(var e=I?0:-O,t=null==h[0],r=d;r<k;r++){var s=h[r];null==s?t=1:(e+=s.length,a&&s.length&&i[n.type+"_encode"](a,s))}if(t&&a)for(r=_,u[0]&&(r=0);r<C;r++)u[r]=null;t&&(e=I?O:0,h[0]=null),a?a.pcmSize+=e:i.recSize+=e},I=n.onProcess(h,c,D,o,d,L);if(!0===I){var P=0;for(y=d;y<k;y++)null==h[y]?P=1:h[y]=new Int16Array(0);P?s("未进入异步前不能清除buffers",3):a?a.pcmSize-=O:i.recSize-=O}else L()},start:function(){if(r.IsOpen()){s("开始录音");var e=this,t=(e.set,r.Ctx);if(e._stop(),e.state=0,e.envStart(null,t.sampleRate),e._SO&&e._SO+1!=e._S)s("start被中断",3);else{e._SO=0;var i=function(){e.state=1,e.resume()};"suspended"==t.state?t.resume().then((function(){s("ctx resume"),i()})):i()}}else s("未open",1)},pause:function(){this.state&&(this.state=2,s("pause"),delete r.Stream._call[this.id])},resume:function(){var e=this;e.state&&(e.state=1,s("resume"),e.envResume(),r.Stream._call[e.id]=function(t,r){1==e.state&&e.envIn(t,r)})},_stop:function(e){var t=this,r=t.set;t.isMock||t._S++,t.state&&(t.pause(),t.state=0),!e&&t[r.type+"_stop"]&&(t[r.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(e,t,i){var n,a=this,o=a.set;s("Stop "+(a.envInLast?a.envInLast-a.envInFirst+"ms 补"+a.envInFix+"ms":"-"));var l=function(){a._stop(),i&&a.close()},c=function(e){s("结束录音失败："+e,1),t&&t(e),l()},h=function(t,r){if(s("结束录音 编码"+(Date.now()-n)+"ms 音频"+r+"ms/"+t.size+"b"),o.takeoffEncodeChunk)s("启用takeoffEncodeChunk后stop返回的blob长度为0不提供音频数据",3);else if(t.size<Math.max(100,r/2))return void c("生成的"+o.type+"无效");e&&e(t,r),l()};if(!a.isMock){if(!a.state)return void c("未开始录音");a._stop(!0)}var d=a.recSize;if(d)if(a.buffers[0])if(a[o.type]){if(a.isMock){var u=a.envCheck(a.mockEnvInfo||{envName:"mock",canProcess:!1});if(u)return void c("录音错误："+u)}var _=a.engineCtx;if(a[o.type+"_complete"]&&_){var f=Math.round(_.pcmSize/o.sampleRate*1e3);return n=Date.now(),void a[o.type+"_complete"](_,(function(e){h(e,f)}),c)}n=Date.now();var m=r.SampleData(a.buffers,a.srcSampleRate,o.sampleRate);o.sampleRate=m.sampleRate;var p=m.data;f=Math.round(p.length/o.sampleRate*1e3),s("采样"+d+"->"+p.length+" 花:"+(Date.now()-n)+"ms"),setTimeout((function(){n=Date.now(),a[o.type](p,(function(e){h(e,f)}),(function(e){c(e)}))}))}else c("未加载"+o.type+"编码器");else c("音频被释放");else c("未采集到录音")}},e.Recorder&&e.Recorder.Destroy(),(e.Recorder=r).LM="2020-11-15 21:36:11",r.TrafficImgUrl="//ia.51.la/go1?id=20469973&pvFlag=1",r.Traffic=function(){var e=r.TrafficImgUrl;if(e){var t=r.Traffic,i=location.href.replace(/#.*/,"");if(0==e.indexOf("//")&&(e=/^https:/i.test(i)?"https:"+e:"http:"+e),!t[i])t[i]=1,(new Image).src=e,s("Traffic Analysis Image: Recorder.TrafficImgUrl="+r.TrafficImgUrl)}}}(window),void 0!==(i=function(){return Recorder}.call(t,r,t,e))&&(e.exports=i),e.exports&&(e.exports=Recorder),function(){"use strict";Recorder.prototype.enc_wav={stable:!0,testmsg:"比特率取值范围8位、16位"},Recorder.prototype.wav=function(e,t,r){var i=this.set,s=e.length,n=i.sampleRate,a=8==i.bitRate?8:16,o=s*(a/8),l=new ArrayBuffer(44+o),c=new DataView(l),h=0,d=function(e){for(var t=0;t<e.length;t++,h++)c.setUint8(h,e.charCodeAt(t))},u=function(e){c.setUint16(h,e,!0),h+=2},_=function(e){c.setUint32(h,e,!0),h+=4};if(d("RIFF"),_(36+o),d("WAVE"),d("fmt "),_(16),u(1),u(1),_(n),_(n*(a/8)),u(a/8),u(a),d("data"),_(o),8==a)for(var f=0;f<s;f++,h++){var m=128+(e[f]>>8);c.setInt8(h,m,!0)}else for(f=0;f<s;f++,h+=2)c.setInt16(h,e[f],!0);t(new Blob([c.buffer],{type:"audio/wav"}))}}()},function(e,t,r){"use strict";r.r(t);let i={createDom:function(e="div",t="",r={},i=""){let s=document.createElement(e);return s.className=i,s.innerHTML=t,Object.keys(r).forEach(t=>{let i=t,n=r[t];"video"===e||"audio"===e?n&&s.setAttribute(i,n):s.setAttribute(i,n)}),s},hasClass:function(e,t){return e.classList?Array.prototype.some.call(e.classList,e=>e===t):!!e.className.match(new RegExp("(\\s|^)"+t+"(\\s|$)"))},addClass:function(e,t){e.classList?t.replace(/(^\s+|\s+$)/g,"").split(/\s+/g).forEach(t=>{t&&e.classList.add(t)}):i.hasClass(e,t)||(e.className+=" "+t)},removeClass:function(e,t){e.classList?t.split(/\s+/g).forEach(t=>{e.classList.remove(t)}):i.hasClass(e,t)&&t.split(/\s+/g).forEach(t=>{let r=new RegExp("(\\s|^)"+t+"(\\s|$)");e.className=e.className.replace(r," ")})},toggleClass:function(e,t){t.split(/\s+/g).forEach(t=>{i.hasClass(e,t)?i.removeClass(e,t):i.addClass(e,t)})},findDom:function(e=document,t){let r;try{r=e.querySelector(t)}catch(i){t.startsWith("#")&&(r=e.getElementById(t.slice(1)))}return r},padStart:function(e,t,r){let i=String(r),s=t>>0,n=Math.ceil(s/i.length),a=[],o=String(e);for(;n--;)a.push(i);return a.join("").substring(0,s-o.length)+o},format:function(e){if(window.isNaN(e))return"";let t=i.padStart(Math.floor(e/3600),2,0),r=i.padStart(Math.floor((e-3600*t)/60),2,0),s=i.padStart(Math.floor(e-3600*t-60*r),2,0);return("00"===t?[r,s]:[t,r,s]).join(":")},event:function(e){if(e.touches){let t=e.touches[0]||e.changedTouches[0];e.clientX=t.clientX||0,e.clientY=t.clientY||0,e.offsetX=t.pageX-t.target.offsetLeft,e.offsetY=t.pageY-t.target.offsetTop}e._target=e.target||e.srcElement},typeOf:function(e){return Object.prototype.toString.call(e).match(/([^\s.*]+)(?=]$)/g)[0]},deepCopy:function(e,t){if("Object"===i.typeOf(t)&&"Object"===i.typeOf(e))return Object.keys(t).forEach(r=>{"Object"!==i.typeOf(t[r])||t[r]instanceof Node?"Array"===i.typeOf(t[r])?e[r]="Array"===i.typeOf(e[r])?e[r].concat(t[r]):t[r]:e[r]=t[r]:e[r]?i.deepCopy(e[r],t[r]):e[r]=t[r]}),e},getBgImage:function(e){let t=(e.currentStyle||window.getComputedStyle(e,null)).backgroundImage;if(!t||"none"===t)return"";let r=document.createElement("a");return r.href=t.replace(/url\("|"\)/g,""),r.href},copyDom:function(e){if(e&&1===e.nodeType){let t=document.createElement(e.tagName);return Array.prototype.forEach.call(e.attributes,e=>{t.setAttribute(e.name,e.value)}),e.innerHTML&&(t.innerHTML=e.innerHTML),t}return""},setInterval:function(e,t,r,i){e._interval[t]||(e._interval[t]=setInterval(r.bind(e),i))},clearInterval:function(e,t){clearInterval(e._interval[t]),e._interval[t]=null},createImgBtn:function(e,t,r,s){let n=i.createDom("xg-"+e,"",{},`xgplayer-${e}-img`);if(n.style.backgroundImage=`url("${t}")`,r&&s){let t,i,a;["px","rem","em","pt","dp","vw","vh","vm","%"].every(e=>!(r.indexOf(e)>-1&&s.indexOf(e)>-1)||(t=parseFloat(r.slice(0,r.indexOf(e)).trim()),i=parseFloat(s.slice(0,s.indexOf(e)).trim()),a=e,!1)),n.style.width=`${t}${a}`,n.style.height=`${i}${a}`,n.style.backgroundSize=`${t}${a} ${i}${a}`,n.style.margin="start"===e?`-${i/2}${a} auto auto -${t/2}${a}`:"auto 5px auto 5px"}return n},Hex2RGBA:function(e,t){let r=[];if(/^\#[0-9A-F]{3}$/i.test(e)){let t="#";e.replace(/[0-9A-F]/gi,(function(e){t+=e+e})),e=t}return/^#[0-9A-F]{6}$/i.test(e)?(e.replace(/[0-9A-F]{2}/gi,(function(e){r.push(parseInt(e,16))})),`rgba(${r.join(",")}, ${t})`):"rgba(255, 255, 255, 0.1)"}};var s=i;let n={get device(){return n.os.isPc?"pc":"mobile"},get browser(){let e=navigator.userAgent.toLowerCase(),t={ie:/rv:([\d.]+)\) like gecko/,firfox:/firefox\/([\d.]+)/,chrome:/chrome\/([\d.]+)/,opera:/opera.([\d.]+)/,safari:/version\/([\d.]+).*safari/};return[].concat(Object.keys(t).filter(r=>t[r].test(e)))[0]},get os(){let e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),r=/(?:SymbianOS)/.test(e)||t,i=/(?:Android)/.test(e),s=/(?:Firefox)/.test(e),n=/(?:iPad|PlayBook)/.test(e)||i&&!/(?:Mobile)/.test(e)||s&&/(?:Tablet)/.test(e),a=/(?:iPhone)/.test(e)&&!n;return{isTablet:n,isPhone:a,isAndroid:i,isPc:!(a||i||r||n),isSymbian:r,isWindowsPhone:t,isFireFox:s}}};var a=n,o=r(0),l=r.n(o);function c(e){return 27==e}function h(e){let t=new DataView(e,0,36),r=4,i=t.getUint32(r,!0);r=8;let s=t.getUint32(r,!0);r=12;let n=t.getUint32(r,!0);r=16;let a=t.getUint32(r,!0);r=32;let o=t.getUint32(r,!0),l=c(h=i)||function(e){return 28==e||29==e}(h);var h;let d=1==i||161==i||18==i||162==i||24==i||168==i,u=8==i;if(d||(9==i||19==i||25==i)){r=24;let e=t.getUint16(r,!0);r+=2;let l=t.getUint16(r,!0);return r+=2,{type:"video",frameNo:s,frameTime:n,frameTimeTickCount:a,frameTimestamp:o,frameType:i,is_key_frame:d,video:{vw:e,vh:l,codecId:t.getUint8(r,!0)}}}if(u){r=24;let e=t.getUint8(r,!0);r+=1;let l=t.getUint8(r,!0);r+=1;let c=t.getUint8(r,!0);return r+=1,{type:"audio",frameNo:s,frameTime:n,frameTimeTickCount:a,frameTimestamp:o,frameType:i,is_audio_frame:u,audio:{codecId:e,samplerate:l,channel:t.getUint8(r,!0),bitrate:c}}}if(l){r=24;let e=t.getUint32(r,!0);return{type:"smart",frameNo:s,frameTime:n,frameTimeTickCount:a,frameTimestamp:o,frameType:i,is_smart_i:c(i),smart:{ivs_node_num:e}}}return{type:"none",frameNo:s,frameTime:n,frameType:i}}function d(e,t,r){let i=document.createElement(e);return i.style.cssText=r,i.setAttribute("name",`${t}-${e}`),i}function u(e,t){if(e.children&&e.children.length>0){let r=null;for(let i of e.children)if(r=u(i,t))return r}else{let i=e.getAttribute("name");if(v.LOG.WARN(i),r=i,"[object String]"===Object.prototype.toString.call(r)&&i.startsWith(t))return e}var r}function _(e,t,r="node"){let i=!1;if(t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement){let s=u(e,r);if(s){let e=s.parentNode;e&&(e.replaceChild(t,s),i=!0)}else v.LOG.ERROR(`error: rootElement:${e} has no prefix:[${r}] node yet!`)}else v.LOG.ERROR("replace_videonode error: invalid video Element:"+videoElement);return i}function f(e,t,r){return e.hasOwnProperty(t)?(console&&console.error&&console.error(e,"already has property[",t,"],ignore this setproperty request!"),!1):(e[t]=r,!0)}function m(e,t,r,i=!1){return e.addEventListener(t,r,i),()=>{e.removeEventListener(t,r,i)}}class p{constructor(e=50){this.last_st=0,this.fps_vec=new Array(e).fill(0,0,e),this.fps_cursor_idx=0}reset(){this.last_st=0,this.fps_cursor_idx=0,this.fps_vec=[].fill(0,0,this.fps_vec.length)}test_fps(){if(0==this.last_st)return this.last_st=performance.now(),0;{let e=performance.now(),t=e-this.last_st;return this.last_st=e,this.fps_vec[this.fps_cursor_idx++]=t,this.fps_cursor_idx==this.fps_vec.length&&(this.fps_cursor_idx=0),t}}get_avrfps(){let e=this.fps_vec.filter(e=>e>0),t=e.reduce((e,t,r,i)=>e+t,0);return 1e3*e.length/t}}class g{constructor(e){if(l()(this),this.config=s.deepCopy({ignores:[],el:null,name:`${(new Date).getTime()}-${parseInt(1e3*Math.random())}`,render_type:"MSE",reconnect:!1},e),this.logParams={},this.rootElement=s.findDom(document,"#"+this.config.id),!this.rootElement){let e=this.config.el;e&&1===e.nodeType?this.rootElement=e:g.LOG.WARN("[CVH5LivePlayer]","rootElement is not set ,You must attach it later!")}this.pluginsCall(),this.rootElement&&this.attach(this.rootElement)}Attach(e){this.attach(e)}attach(e){this.emit("decoder_attach",null),this.emit("smartdecoder_attach",null),this.rootElement=e,this.rootElement.innerHTML="";let t=document.createDocumentFragment(),r=d("div",this.config.name,"\n             position:relative;\n             width:100%;\n             height:100%;\n\n         "),i=d("canvas","mask-"+this.config.name,"\n             width:100%;\n             height:100%;\n\n             position:absolute;\n             left:0;\n             top:0;\n             right:0;\n             bottom:0;\n\n             z-index: 999;\n         "),s=d("div","rendertarget-"+this.config.name,"");r.appendChild(s),r.appendChild(i),t.appendChild(r),t?(e.appendChild(t),this.mask_canvas=i,this.emit("decoder_attach",e),this.emit("smartdecoder_attach",i)):LOG.ERROR("[liveplayer]","_createRenderTarget failed!")}play(e){e?(this.logParams.cinfo=e,this.emit("open_request",e)):this.emit("invalid_client_info")}stop(){this.emit("abort_request"),this.emit("player_stream_closed",this.config.logParams)}capture(){}resize(e,t){}get volumne(){return this.get_volumne?this.get_volumne():g.LOG.ERROR("未实现CVPlayer.get_volumne")}set volumne(e){this.set_volumne?this.set_volumne(e):g.LOG.ERROR("未实现CVPlayer.set_volumne")}SwitchAudio(){if(this.get_volumne&&this.set_volumne)if(0==arguments.length){this.get_volumne()-0<=1e-6?this.set_volumne(1):this.set_volumne(0)}else 1==arguments.length&&this.set_volumne(arguments[0]);else g.LOG.ERROR("未实现CVPlayer.get_volumne or CVPlayer.set_volumne")}get smartconfig(){return this.get_smartconfig?this.get_smartconfig():g.LOG.ERROR("未实现CVPlayer.get_smartconfig")}set smartconfig(e){this.set_smartconfig?this.set_smartconfig(e):g.LOG.ERROR("未实现CVPlayer.set_smartconfig")}get enable_smart(){return this.get_smartconfig?this.get_smartconfig():g.LOG.ERROR("未实现CVPlayer.get_smartconfig")}set enable_smart(e){this.set_smartconfig?this.set_smartconfig(e):g.LOG.ERROR("未实现CVPlayer.set_smartconfig")}set delay(e){this.set_delay?this.set_delay(e):g.LOG.ERROR("未实现CVPlayer.set_delay")}destroy(e=!0){this.mask_canvas=null,this.emit("destroy",{isDelDom:e})}pluginsCall(){if(g.plugins){let e=this.config.ignores;Object.keys(g.plugins).forEach(t=>{let{autorun:r,loadStatus:i,dependencies:s}=g.plugins[t];if(!e.some(e=>t===e)){let e=[];if(s.forEach(t=>{let{autorun:r,loadStatus:i,dependencies:s}=g.plugins[t];e.push(i)}),0!=e.length&&!e.every(e=>e))return;r.call(this,this),g.plugins[t].loadStatus=!0}})}}static install(e,t,r=[]){g.plugins||(g.plugins={}),g.plugins[e]={autorun:t,loadStatus:!1,dependencies:r}}}g.sniffer=a,g.util=s,g.LOG={DEBUG:function(){"console"in window&&console.log.apply(console,arguments)},WARN:function(){"console"in window&&console.warn.apply(console,arguments)},ERROR:function(){"console"in window&&console.error.apply(console,arguments)}};var v=g;v.install("ws-loader",(function(){let e=this,t=v.LOG;if(!window.WebSocket||!window.WebSocket.prototype.send)return void t.ERROR("websocket unsupported!ws-loader init failed!");let r=e=>{t.WARN("ws open success!",this._ws,e),this._ws=e.target,this.emit("send",this.logParams.cinfo.cmd)},i=e=>{if(t.WARN("[ws]","conn closed cb fired! code request:"+this._requestAbort),!0===this._requestAbort)this.emit("ws_error_close"),this._requestAbort=!1;else{let e={code:255,msg:"server close the conn,maybe a long time net out occurs!"};this.emit("ws_error_close",e)}this._ws=null,this._ws_socket_error=!1,this.emit("loading_tips",{show:!1}),this.emit("player_stream_closed",this.config.logParams)},s=e=>{this.emit("check_stream_bytes_timeout"),e.data instanceof ArrayBuffer&&n(e.data)},n=e=>{let t=e,r=this._receivedLength;this._receivedLength+=t.byteLength;let i=h(t);this.emit("streaminfo_inputtick",i),i.is_key_frame&&(this._recv_first_iframe||(this._recv_first_iframe=!0,this.emit("loading_tips",{show:!1}),this.emit("player_stream_opened",this.config.logParams)));let{Video:s,Audio:n,Smart:a}=this.logParams.cinfo.cmd.Data;"video"==i.type&&s?this.emit("ws_data_incoming_video",{header:i,chunk:t,recv:{byteStart:r,byteEnd:this._receivedLength}}):"audio"==i.type&&n?this.emit("ws_data_incoming_audio",{header:i,chunk:t,recv:{byteStart:r,byteEnd:this._receivedLength}}):"smart"==i.type&&a&&this.emit("ws_data_incoming_smart",{header:i,chunk:t,recv:{byteStart:r,byteEnd:this._receivedLength}})},a=e=>{let r={code:e.code,msg:e.message};t.ERROR("ws error occrus",r),this._ws_socket_error=!0},o=e=>{this._recv_first_iframe=!1,this.emit("loading_tips",{show:!0});try{this._ws_socket_error=!1,t.WARN("try open ws: "+e.url),this._ws=new WebSocket(e.url,e.protocols),this._ws.binaryType="arraybuffer",this._ws.onopen=r.bind(this),this._ws.onclose=i.bind(this),this._ws.onmessage=s.bind(this),this._ws.onerror=a.bind(this)}catch(e){let r={code:e.code,msg:e.message};t.ERROR("[ws]",r)}};f(e,"_ws",null),f(e,"_ws_socket_error",!1),f(e,"_requestAbort",!1),f(e,"_receivedLength",0),f(e,"_recv_first_iframe",!0);const l=e=>{t.DEBUG(this.config.name,e),this._ws&&1==this._ws.readyState?(this._ws.close(),this._ws.onclose=function(){t.WARN("play run after play,conn close first"),this._ws=null,this._ws_socket_error=!1,o(e)}.bind(this)):o(e)};e.on("open_request",l);const c=e=>{this._ws&&1==this._ws.readyState&&(t.DEBUG(e),this._ws.send(JSON.stringify(e)))};e.on("send",c);const d=()=>{let e=this._ws;!e||0!==e.readyState&&1!==e.readyState||(this._requestAbort=!0,e.close(),t.WARN("ws abort and closed!"))};e.on("abort_request",d);const u=()=>{e.off("open_request",l),e.off("abort_request",d),e.off("send",c),this._ws&&(this._ws.onopen=null,this._ws.onclose=null,this._ws.onmessage=null,this._ws.onerror=null,this._ws=null),e.off("destroy",u)};e.on("destroy",u)}),[]);v.install("reconnector",(function(){let e=this,t=v.LOG;if(!this.config.reconnect)return void t.WARN("reconnect flag is ",!!this.config.reconnect);f(this,"_reconnector",{listenOn:!1,tid:null,bytes_timeout:5e3});const r=()=>{this._reconnector.tid&&clearTimeout(this._reconnector.tid),!this._ws_socket_error&&this._requestAbort||(t.ERROR("detect error close! ,just run  reconnecting "),this.emit("open_request",this.logParams.cinfo))};e.on("ws_error_close",r);const i=()=>{this._reconnector.tid&&clearTimeout(this._reconnector.tid),this._reconnector.tid=setTimeout(()=>{t.ERROR("detect no stream bytes arraived in",this._reconnector.bytes_timeout,"ms,just run  reconnecting "),this.emit("open_request",this.logParams.cinfo)},this._reconnector.bytes_timeout)},s=()=>{this._reconnector.listenOn||e.on("check_stream_bytes_timeout",i)};e.on("send",s);const n=()=>{this._requestAbort&&(e.off("check_stream_bytes_timeout",i),this._reconnector.tid&&clearTimeout(this._reconnector.tid),this._reconnector.listenOn=!1)};e.on("abort_request",n);const a=()=>{e.off("ws_error_close",r),e.off("check_stream_bytes_timeout",i),e.off("abort_request",n),e.off("send",s),e.off("destroy",a)};e.on("destroy",a)}),["ws-loader"]);var y=class{constructor(e="",t=60){this.requestID=0,this.fps=t,this.interval=1e3/this.fps,this._cb=()=>{},this.LOG=v.LOG,this.name=e,0==this.name.length&&(this.name=performance.now())}set renderfps(e){this.fps=e,this.interval=1e3/this.fps}get renderfps(){return this.fps}set_workcb(e){this._cb=e}start(){if(0!=this.requestID)return void this.LOG.ERROR(`[${this.name}]`,"Animaite is running yet,You should stop animate before start it!");let e=performance.now();const t=r=>{this.requestID=requestAnimationFrame(t);const i=r-e;i>=this.interval&&(e=r-i%this.interval,this._cb&&this._cb(i))};this.requestID=requestAnimationFrame(t)}stop(){this.requestID>0&&(cancelAnimationFrame(this.requestID),this.requestID=0,this.LOG.WARN(`[${this.name}]`,"animate stop!"))}};var w=class{constructor(e){if(e=e||{},this.canvasElement=e.canvas,!this.canvasElement)throw new Error("can't create YUVCanvas instance,no provide canvas found!");this.contextOptions=e.contextOptions,this.type="yuv420",this.customYUV444=!1,this.conversionType=e.conversionType||"rec601",this.width=e.width||352,this.height=e.height||288,this.canvasElement.width=this.width,this.canvasElement.height=this.height,this.animationTime=e.animationTime||0,this.drawMode=e.drawMode||"WebGL",this.initContextGL(),this.contextGL&&(this.initProgram(),this.initBuffers(),this.initTextures()),this._tmpCanvas=document.createElement("canvas"),"yuv420"===this.type?this.drawNextOuptutPictureGL=function(e){var t=this.contextGL,r=this.texturePosBuffer,i=this.uTexturePosBuffer,s=this.vTexturePosBuffer,n=this.yTextureRef,a=this.uTextureRef,o=this.vTextureRef,l=e.yData,c=e.uData,h=e.vData,d=this.width,u=this.height,_=e.yDataPerRow||d,f=e.yRowCnt||u,m=e.uDataPerRow||d/2,p=e.uRowCnt||u/2,g=e.vDataPerRow||m,v=e.vRowCnt||p;t.viewport(0,0,d,u);var y=1,w=1,b=new Float32Array([w,0,0,0,w,y,0,y]);t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,b,t.DYNAMIC_DRAW),this.customYUV444&&(y=u/p,w=d/m);var R=new Float32Array([w,0,0,0,w,y,0,y]);t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,R,t.DYNAMIC_DRAW),this.customYUV444&&(y=u/v,w=d/g);var E=new Float32Array([w,0,0,0,w,y,0,y]);t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,E,t.DYNAMIC_DRAW),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,_,f,0,t.LUMINANCE,t.UNSIGNED_BYTE,l),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,a),t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,m,p,0,t.LUMINANCE,t.UNSIGNED_BYTE,c),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,o),t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,g,v,0,t.LUMINANCE,t.UNSIGNED_BYTE,h),t.drawArrays(t.TRIANGLE_STRIP,0,4)}:"yuv422"===this.type&&(this.drawNextOuptutPictureGL=function(e){var t=this.contextGL,r=this.texturePosBuffer,i=this.textureRef,s=e.data,n=this.width,a=this.height,o=e.dataPerRow||2*n,l=e.rowCnt||a;t.viewport(0,0,n,a);var c=a/l,h=n/(o/2),d=new Float32Array([h,0,0,0,h,c,0,c]);t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,d,t.DYNAMIC_DRAW),t.uniform2f(t.getUniformLocation(this.shaderProgram,"resolution"),o,a),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,o,l,0,t.LUMINANCE,t.UNSIGNED_BYTE,s),t.drawArrays(t.TRIANGLE_STRIP,0,4)})}clear(){var e=this.contextGL;e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT)}get canvas(){return this.canvasElement}get DrawMode(){return this.drawMode}initContextGL(){for(var e=this.canvasElement,t=null,r=["webgl","experimental-webgl","moz-webgl","webkit-3d"],i=0;!t&&i<r.length;){var s=r[i];try{t=this.contextOptions?e.getContext(s,this.contextOptions):e.getContext(s)}catch(e){t=null}t&&"function"==typeof t.getParameter||(t=null),++i}this.contextGL=t,this.contextGL||console.error("WebGL init failed!")}initProgram(){var e,t,r=this.contextGL;"yuv420"===this.type?(e=["attribute vec4 vertexPos;","attribute vec4 texturePos;","attribute vec4 uTexturePos;","attribute vec4 vTexturePos;","varying vec2 textureCoord;","varying vec2 uTextureCoord;","varying vec2 vTextureCoord;","void main()","{","  gl_Position = vertexPos;","  textureCoord = texturePos.xy;","  uTextureCoord = uTexturePos.xy;","  vTextureCoord = vTexturePos.xy;","}"].join("\n"),t=["precision highp float;","varying highp vec2 textureCoord;","varying highp vec2 uTextureCoord;","varying highp vec2 vTextureCoord;","uniform sampler2D ySampler;","uniform sampler2D uSampler;","uniform sampler2D vSampler;","uniform mat4 YUV2RGB;","void main(void) {","  highp float y = texture2D(ySampler,  textureCoord).r;","  highp float u = texture2D(uSampler,  uTextureCoord).r;","  highp float v = texture2D(vSampler,  vTextureCoord).r;","  gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;","}"].join("\n")):"yuv422"===this.type&&(e=["attribute vec4 vertexPos;","attribute vec4 texturePos;","varying vec2 textureCoord;","void main()","{","  gl_Position = vertexPos;","  textureCoord = texturePos.xy;","}"].join("\n"),t=["precision highp float;","varying highp vec2 textureCoord;","uniform sampler2D sampler;","uniform highp vec2 resolution;","uniform mat4 YUV2RGB;","void main(void) {","  highp float texPixX = 1.0 / resolution.x;","  highp float logPixX = 2.0 / resolution.x;","  highp float logHalfPixX = 4.0 / resolution.x;","  highp float steps = floor(textureCoord.x / logPixX);","  highp float uvSteps = floor(textureCoord.x / logHalfPixX);","  highp float y = texture2D(sampler, vec2((logPixX * steps) + texPixX, textureCoord.y)).r;","  highp float u = texture2D(sampler, vec2((logHalfPixX * uvSteps), textureCoord.y)).r;","  highp float v = texture2D(sampler, vec2((logHalfPixX * uvSteps) + texPixX + texPixX, textureCoord.y)).r;","  gl_FragColor = vec4(y, u, v, 1.0) * YUV2RGB;","}"].join("\n"));var i=[];i="rec709"==this.conversionType?[1.16438,0,1.79274,-.97295,1.16438,-.21325,-.53291,.30148,1.16438,2.1124,0,-1.1334,0,0,0,1]:[1.16438,0,1.59603,-.87079,1.16438,-.39176,-.81297,.52959,1.16438,2.01723,0,-1.08139,0,0,0,1];var s=r.createShader(r.VERTEX_SHADER);r.shaderSource(s,e),r.compileShader(s),r.getShaderParameter(s,r.COMPILE_STATUS)||LOG.ERROR("Vertex shader failed to compile: "+r.getShaderInfoLog(s));var n=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(n,t),r.compileShader(n),r.getShaderParameter(n,r.COMPILE_STATUS)||LOG.ERROR("Fragment shader failed to compile: "+r.getShaderInfoLog(n));var a=r.createProgram();r.attachShader(a,s),r.attachShader(a,n),r.linkProgram(a),r.getProgramParameter(a,r.LINK_STATUS)||LOG.ERROR("Program failed to compile: "+r.getProgramInfoLog(a)),r.useProgram(a);var o=r.getUniformLocation(a,"YUV2RGB");r.uniformMatrix4fv(o,!1,i),this.shaderProgram=a}initBuffers(){var e=this.contextGL,t=this.shaderProgram,r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),e.STATIC_DRAW);var i=e.getAttribLocation(t,"vertexPos");if(e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0),this.animationTime){var s=this.animationTime,n=0,a=function(){var r=1*(n+=15)/s;n>=s?r=1:setTimeout(a,15);var i=-1*r,o=1*r,l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,new Float32Array([o,o,i,o,o,i,i,i]),e.STATIC_DRAW);var c=e.getAttribLocation(t,"vertexPos");e.enableVertexAttribArray(c),e.vertexAttribPointer(c,2,e.FLOAT,!1,0,0);try{e.drawArrays(e.TRIANGLE_STRIP,0,4)}catch(e){}};a()}var o=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),e.STATIC_DRAW);var l=e.getAttribLocation(t,"texturePos");if(e.enableVertexAttribArray(l),e.vertexAttribPointer(l,2,e.FLOAT,!1,0,0),this.texturePosBuffer=o,"yuv420"===this.type){var c=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,c),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),e.STATIC_DRAW);var h=e.getAttribLocation(t,"uTexturePos");e.enableVertexAttribArray(h),e.vertexAttribPointer(h,2,e.FLOAT,!1,0,0),this.uTexturePosBuffer=c;var d=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),e.STATIC_DRAW);var u=e.getAttribLocation(t,"vTexturePos");e.enableVertexAttribArray(u),e.vertexAttribPointer(u,2,e.FLOAT,!1,0,0),this.vTexturePosBuffer=d}}initTextures(){var e=this.contextGL,t=this.shaderProgram;if("yuv420"===this.type){var r=this.initTexture(),i=e.getUniformLocation(t,"ySampler");e.uniform1i(i,0),this.yTextureRef=r;var s=this.initTexture(),n=e.getUniformLocation(t,"uSampler");e.uniform1i(n,1),this.uTextureRef=s;var a=this.initTexture(),o=e.getUniformLocation(t,"vSampler");e.uniform1i(o,2),this.vTextureRef=a}else if("yuv422"===this.type){var l=this.initTexture(),c=e.getUniformLocation(t,"sampler");e.uniform1i(c,0),this.textureRef=l}}initTexture(){var e=this.contextGL,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),t}drawNextOutputPicture(e){this.contextGL?this.drawNextOuptutPictureGL(e):this.drawNextOuptutPictureRGBA(e)}drawNextOuptutPictureRGBA(e){var t=new ImageData(new Uint8ClampedArray(e.ar),e.w,e.h);this._tmpcanvas.width=t.width,this._tmpcanvas.height=t.height,this._tmpcanvas.getContext("2d").putImageData(t,0,0),this.canvasElement.drawImage(this._tmpcanvas,0,0,this.width,this.height)}};var b=function(){isErrored=!1,hasInitDecoder=!1,output_format=null,drop_until_i=!0,self.Module={};try{importScripts(self.location.origin+"/static/worker/cvdecoder.js")}catch(e){isErrored=!0}Module.onRuntimeInitialized=function(){self.VideoCodec=Module.VideoCodec,self.CVAVTrackDecoder=Module.CVAVTrackDecoder,e=new CVAVTrackDecoder,hasInitDecoder=0==e.CreateDecodeContext(0),self.last_malloc_bytes=0,self.ptr=0,self.decoderinfo={decode_cost_ms_min:1e4,decode_cost_ms_max:0,decode_cost_ms_avr:0,decode_cost_ms_list:[]},self.par_OnI420Decoded=function(e,t,r,i,s,n,a){let o=new Uint8Array(n*a);o.set(new Uint8ClampedArray(Module.HEAPU8.buffer,e,o.byteLength));let l=new Uint8Array(n*a/4);l.set(new Uint8ClampedArray(Module.HEAPU8.buffer,t,l.byteLength));let c=new Uint8Array(n*a/4);c.set(new Uint8ClampedArray(Module.HEAPU8.buffer,r,c.byteLength)),self.postMessage({type:"decoded_frame",w:n,h:a,mode:"yuv",yData:o.buffer,uData:l.buffer,vData:c.buffer,frameTime:s,frametype:i},[o.buffer,l.buffer,c.buffer])},onmessage=function(t){var r=t.data;switch(r.type){case"RawFrame":{if(!hasInitDecoder)return;if(r.header.is_key_frame)r.forceInitSegment&&(self.decoderinfo={decode_cost_ms_min:1e4,decode_cost_ms_max:0,decode_cost_ms_avr:0,decode_cost_ms_list:[]}),drop_until_i=!1;else if(drop_until_i)return;let o=performance.now(),l=t.data.ar;var i=(s=new Uint8Array(l)).BYTES_PER_ELEMENT*s.length;for(a=Module._malloc(i),(n=new Uint8Array(Module.HEAPU8.buffer,a,i)).set(s);;){let t=e.decode_frame(n.byteOffset,!0);if(0==t){let e=performance.now()-o;e<self.decoderinfo.decode_cost_ms_min&&(self.decoderinfo.decode_cost_ms_min=e),e>self.decoderinfo.decode_cost_ms_max&&(self.decoderinfo.decode_cost_ms_max=e);let t=self.decoderinfo.decode_cost_ms_list;t.length>=100&&t.shift(),t.push(e),self.decoderinfo.decode_cost_ms_avr=t.reduce((e,t,r,i)=>t+e,0)/t.length;break}if(t<0)console.log("decode failed,reset decoder!",t),e.DestroyDecodeContext(),hasInitDecoder=!1,e=new CVAVTrackDecoder,hasInitDecoder=0==e.CreateDecodeContext(0),drop_until_i=!0;else if(1==t)continue}Module._free(a),a=0}break;case"Destory":hasInitDecoder&&(e.delete(),last_malloc_bytes&&Module._free(a),hasInitDecoder=!1),self.close();break;case"Audio2wav":let o=t.data.content;i=(s=new Uint8Array(o)).BYTES_PER_ELEMENT*s.length;var s,n,a=Module._malloc(i);if((n=new Uint8Array(Module.HEAPU8.buffer,a,i)).set(s),0==Module.audio2wav(n.byteOffset,i)){let e=new Uint8Array(Module.getwavbytes());self.postMessage({type:"WavArrayBuffer",ab:e},[e.buffer])}Module._free(a)}},postMessage({type:"worker_decoder_resource_loaded_success",status:!0})};var e=null;isErrored&&postMessage({type:"worker_decoder_resource_loaded_success",status:!1})};const R={worker_remuxer_resource_loaded_success:"webworker_remuxer_res_init_ok",worker_decoder_resource_loaded_success:"webworker_decoder_res_init_ok"};var E=class{constructor(e,t){this.ob=e,this._queue=[];let r=t.toString();r=r.substring(r.indexOf("{")+1,r.lastIndexOf("}"));const i=new Blob([r],{type:"application/javascript"});this._worker_script=URL.createObjectURL(i),this._worker=new Worker(this._worker_script);const s=e=>{this._queue.length&&this._queue.shift().resolve(e.data)};this._worker.onmessage=e=>{R[e.data.type]&&(this.ob.emit(R[e.data.type],e.data.status),e.data.status&&(this._worker.onmessage=null,this.remove_msg=m(this._worker,"message",s.bind(this))))},this.remove_error=m(this._worker,"error",e=>{this._queue.length&&this._queue.shift().reject(e)})}dispatch(...e){return new Promise((t,r)=>{this._queue.push({resolve:t,reject:r}),this._worker.postMessage(...e)})}terminate(){this._queue=[],this._worker.terminate(),this.remove_error(),this._worker.onmessage?this._worker.onmessage=null:this.remove_msg(),URL.revokeObjectURL(this._worker_script)}};var U=class{constructor(e){this.ob=e,this.LOG=v.LOG,e.rootElement||this.LOG.WARN("[decoder]","not set rootElement, Attach it when you begin to use the ob object!"),this._el=e.rootElement,this.worker=null,this.yuvcanvas=null,this.render=new y("ffmpeg-decoder",30),this._raw_bufferd_framenum=30,this._raw_videoframes=[],this._yuvframes_threshold=3,this._yuvframes=[],this._force_first_initSegment=!0,this._isOperateOver=!0,this.prefix="[decoder]",this.reset()}load_webworker(){return new Promise((e,t)=>{this.ob.once("webworker_decoder_res_init_ok",t=>{e(t?this.worker:null)}),this.worker=new E(this.ob,b)})}destroy(){this.worker&&this.worker.terminate()}_process_resolution_changed({codecId:e,width:t,height:r}){this.LOG.WARN("resolution changed",t,r)}check_timestamp(e,t){t<25?t=25:t<=30||(t=30),t!=this.render.renderfps&&(this.LOG.WARN("[decoder]",`fps changed : [${this.render.renderfps}]--\x3e[${t}]`),this.render.renderfps=t)}_process_worker_msg(e){switch(e.type){case"decoded_frame":this._yuvframes.length>=this._yuvframes_threshold&&this._yuvframes.shift(),"yuv"==e.mode&&this._yuvframes.push(e),this._force_first_initSegment&&(this._force_first_initSegment=!1),this._isOperateOver=!0,this.feed_segments()}}_check_delay_and_try_drop(){return!(this._raw_videoframes.length<this._raw_bufferd_framenum)&&(this.LOG.WARN("[decoder]",`videoframs:${this._raw_videoframes.length} >= maxvideoframes ${this._raw_bufferd_framenum} ,will drop`),this._drop_until_wait_i=!0,!0)}send_msg_to_worker(e){this.worker&&this.worker.dispatch(e)}input_data(e){if(e){if(this._drop_until_wait_i){if(!e.header.is_key_frame||16!=e.header.video.codecId)return;this._drop_until_wait_i=!1}this._raw_videoframes.push(e)}}feed_segments(){if(this._isOperateOver&&this.worker){let e=this._raw_videoframes.shift();e&&(this.worker.dispatch({type:"RawFrame",header:e.header,ar:e.payload,forceInitSegment:this._force_first_initSegment},[e.payload]).then(e=>{this._process_worker_msg(e)}).catch(e=>{this.LOG.ERROR(e),this._drop_until_wait_i=!0,this._isOperateOver=!0}),this._isOperateOver=!1)}}draw(e){let t=this._yuvframes.shift();if(this.yuvcanvas&&t)if(t.frameTime!=this.tmp_timestamp&&(this.tmp_timestamp=t.frameTime,this.ob.emit("player_current_utctime",{timestamp_utc:this.tmp_timestamp})),t.mode="yuv"){let e={yData:new Uint8Array(t.yData),yDataPerRow:t.w,yRowCnt:t.h,uData:new Uint8Array(t.uData),uDataPerRow:t.w/2,uRowCnt:t.h/2,vData:new Uint8Array(t.vData),vDataPerRow:t.w/2,vRowCnt:t.h/2};this.yuvcanvas.drawNextOutputPicture(e)}else(t.mode="rgba")&&this.yuvcanvas.drawNextOutputPicture(t)}start(){this.worker&&(this.tmp_timestamp=null,this.render.set_workcb(this.draw.bind(this)),this.render.start())}stop(){this.render.set_workcb(null),this.render.stop(),this.reset(),this.yuvcanvas&&this.yuvcanvas.clear()}reset(){this._yuvframes=[],this._raw_videoframes=[],this._isOperateOver=!0,this._drop_until_wait_i=!0,this._force_first_initSegment=!0}set fast_draw_i_frame_mode(e){e?(this._raw_videoframes=[],this._drop_until_wait_i=!0,this._raw_bufferd_framenum=1):(this._raw_videoframes=[],this._drop_until_wait_i=!0,this._raw_bufferd_framenum=10)}create_videoObject(){return this._video=d("canvas","rendertarget-"+this._name,"\n             width:100%;\n             height:100%;\n             background-color:#000000;\n         ")}attach(e,t,r){if(e){let i=this.create_videoObject();_(e,i,"rendertarget")&&(this.stop(),this._video=i,this.LOG.DEBUG("attach canvas rect:",e.clientWidth,e.clientHeight),this.yuvcanvas=new w({canvas:this._video,drawMode:this.drawmode,width:t||e.clientWidth,height:r||e.clientHeight,contextOptions:{preserveDrawingBuffer:!0}}))}else this.stop(),this._video=null,this.yuvcanvas&&(this.yuvcanvas.canvasElement=null,this.yuvcanvas=null)}set delay(e){let t=Math.max(30,parseInt(1e3*e.normal/40,10));this._raw_bufferd_framenum=t}capture(){if(this._video){let e=document.createElement("canvas"),t=e.getContext("2d"),r=this._video;return e.width=720,e.height=576,t.drawImage(r,0,0,r.width,r.height,0,0,720,576),e}}resize(e,t){this.yuvcanvas&&(this.yuvcanvas=new w({canvas:this.yuvcanvas.canvas,width:e,height:t}))}};const x=0,A=1,O=2,S=3,T=4,D=5;var k=class{constructor(e){if(!e)throw new Error(`CVMSERender constructor: invalid ob[${e}]`);this.mediaElement=null,this.mediaSource=null,this.datalist=[],this.isUpdating=!1,this.wait_for_initsegment=!0,this.codecs="",this.ob=e,this._status_code=x,this.tmp_timestamp=0,this.LOG=v.LOG}attachMedia(e){e?(this.mediaElement,this.mediaElement=e,this._status_code=A):this.LOG.ERROR("[CVMSERender]","invalid Video!")}Init(e=""){if(0==e.length||!e.startsWith("video/mp4;"))return this.LOG.ERROR("[CVMSERender]",`Invalid codec:[${e}]!`),this._status_code=D,-1;if(!window.MediaSource||!window.MediaSource.isTypeSupported(e))return this.LOG.ERROR("[CVMSERender]",`Unsupoorted codec:[${e}]!`),this._status_code=D,-2;if(!this.mediaElement)return this.LOG.ERROR("[CVMSERender]",`Invalid Atatched MediaElement(Video):${this.mediaElement} !`),-3;this.codecs=e;let t=function(e){this.LOG.ERROR("[CVMSERender]",e),this.mediaElement.removeEventListener("error",t),this._status_code=T};this.remove_video_err_fn=m(this.mediaElement,"error",t.bind(this)),this.remove_video_canplay_fn=m(this.mediaElement,"canplay",function(){this.mediaElement.play()}.bind(this)),this.mediaSource=new window.MediaSource,this.url&&URL.revokeObjectURL(this.url),this.url=window.URL.createObjectURL(this.mediaSource),this.mediaElement.src=this.url,this.LOG.WARN("[CVMSERender]","video.error:",this.mediaElement.error,"video.readyState:",this.mediaElement.readyState),this.remove_mse_sourceopen=m(this.mediaSource,"sourceopen",function(){this.LOG.DEBUG("[CVMSERender]","SourceBuffer open:",e),this.sourceBuffer=this.mediaSource.addSourceBuffer(e),this.sourceBuffer.addEventListener("error",(function(e){this.LOG.ERROR("[CVMSERender]",e)})),this.sourceBuffer.addEventListener("updateend",function(e){this.isUpdating=!1,this._feed_segments()}.bind(this));let t=this.datalist.findIndex(t=>1==t.initSegment&&t.codec==e);-1!=t&&this.datalist.splice(0,t),this._status_code=S,this.LOG.DEBUG("[CVMSERender]","Init MSE over"),this.ob.emit("decoder_readyfor_feeding","remuxer")}.bind(this));let r=function(){this.LOG.DEBUG("[CVMSERender]","source close"),this.mediaSource.removeEventListener("sourceclose",r),this._status_code=A}.bind(this);this.remove_mse_sourceclose=m(this.mediaSource,"sourceclose",r);let i=function(){this.LOG.DEBUG("[CVMSERender]","source ended"),this.mediaSource.removeEventListener("sourceclose",i),this._status_code=A}.bind(this);return this.remove_mse_sourceended=m(this.mediaSource,"sourceended",i),0}_feed_segments(){if(this.mediaSource&&"open"==this.mediaSource.readyState&&this._status_code==S){if(this.sourceBuffer&&0==this.isUpdating){let e=this.datalist.shift();if(!e)return;if(this.wait_for_initsegment){if(!e.initSegment||e.codec!=this.codecs)return void this.LOG.DEBUG("[CVMSERender]","drop",e.initSegment,e.codec,e.pts);this.LOG.DEBUG("[CVMSERender]","got matched codec InitSegment!",e.initSegment,e.codec,e.pts),this.wait_for_initsegment=!1}if("open"==this.mediaSource.readyState)try{e.frameTime!=this.tmp_timestamp&&(this.tmp_timestamp=e.frameTime,this.ob.emit("player_current_utctime",{utctime:this.tmp_timestamp-this.delay})),this.sourceBuffer.appendBuffer(e.ar),this.isUpdating=!0}catch(e){this.reset(),this.LOG.ERROR("[CVMSERender]","sourcebuffer append error!just reset and try recover")}}}else this.LOG.WARN("[CVMSERender]",this._status_code)}input_data(e){let{ar:t,codec:r,initSegment:i}=e;if(r=e.codec=`video/mp4; codecs="${r}"`,this.mediaElement.error||this._status_code==T||this._status_code==x&&0==i)this.LOG.ERROR("[CVMSERender]",`error ocurrs! ${this.mediaElement.error}| ${this._status_code}`,i);else{if(this.codecs!=r&&1==i){if(this._status_code!=O?(this.LOG.WARN("[CVMSERender]","render detect coedc changed !",this.codecs,r),this._status_code=O):(this.LOG.WARN("[CVMSERender]","codec changed reset"),this.reset()),!i)return this._status_code=x,void this.LOG.ERROR("[CVMSERender]"," codec changed detect but this frame is invalid,because initSegment == 0!");try{this.Init(r)}catch(e){this.LOG.ERROR("[CVMSERender]",e),this._status_code=A}}this._status_code!=D&&(this.datalist.push(e),this._status_code==S&&this._feed_segments())}}get delay(){return this._status_code==S&&this.mediaElement&&this.mediaElement.played&&this.mediaElement.buffered&&this.mediaElement.played.length&&this.mediaElement.buffered.length?this.mediaElement.buffered.end(0)-this.mediaElement.played.end(0):0}reset(e=!1){this.datalist=[],this._status_code=e?x:A,this.codecs="",this.isUpdating=!1,this.wait_for_initsegment=!0,this.tmp_timestamp=0;try{this.mediaSource&&"open"===this.mediaSource.readyState&&this.mediaSource.endOfStream()}catch(e){}this.mediaElement&&(this.mediaElement.removeAttribute("src"),this.mediaElement.load(),this.LOG.DEBUG("[CVMSERender]","stop at time:",this.mediaElement.currentTime,this.mediaElement.error,this.mediaElement.readyState))}set playrate(e=1){this.mediaElement&&this.mediaElement.playbackRate&&e>0&&(this.mediaElement.playbackRate=e)}get playrate(){return this.mediaElement&&this.mediaElement.playbackRate?this.mediaElement.playbackRate:1}destroy(){this.reset(!0),this.url&&URL.revokeObjectURL(this.url),this.remove_mse_sourceclose&&this.remove_mse_sourceclose(),this.remove_mse_sourceopen&&this.remove_mse_sourceopen(),this.remove_video_canplay_fn&&this.remove_video_canplay_fn(),this.remove_video_err_fn&&this.remove_video_err_fn(),this.remove_mse_sourceended&&this.remove_mse_sourceended(),this.mediaElement=null,this.mediaSource=null}};var C=function(){var e=!1;self.Module={};try{importScripts(self.location.origin+"/static/worker/cvremuxer.js")}catch(t){e=!0}var t=null,r=0,i=0;Module.onRuntimeInitialized=function(){self.CVStreamTransmuxer=Module.CVStreamTransmuxer,t=new CVStreamTransmuxer(0),self.par_OnFMp4VideoData=function(e,t,r,i,s,n,a){var o=new Uint8Array(i);o.set(new Uint8ClampedArray(Module.HEAPU8.buffer,r,o.byteLength)),self.postMessage({type:"remuxed_fmp4_videoframe",frameTime:n,frameType:s,initSegment:e,codec:t,pts:a,ar:o.buffer},[o.buffer])},onmessage=function(e){let s=e.data;switch(s.type){case"VideoRawFrame":let e=s.ar,l=s.duration;s.reInitSegment&&(t.delete(),t=null,t=new CVStreamTransmuxer(0));var n=new Uint8Array(e),a=n.BYTES_PER_ELEMENT*n.length;r<a&&(0!=r&&(Module._free(i),i=0),i=Module._malloc(a),r=a);var o=new Uint8Array(Module.HEAPU8.buffer,i,a);o.set(n),t.transmux_frame(o.byteOffset,l,s.reInitSegment);break;case"Destory":t.delete(),t=null,0!=i&&(Module._free(i),i=0),self.postMessage({type:"Destroy"}),self.close()}},postMessage({type:"worker_remuxer_resource_loaded_success",status:!0})},e&&postMessage({type:"worker_remuxer_resource_loaded_success",status:!1})};var L=class{constructor(e){this.ob=e,this.LOG=v.LOG,e.rootElement||this.LOG.WARN("[remuxer]","not set rootElement, Attach it when you begin to use the player object!"),this._el=e.rootElement,this._video=null,this.render=null,this.pts=0,this.duration_of_segment=40,this.delay_ctrl_vals={normal:.6},this.duration_adjust_val=0,this.worker=null,this.prefix="[remuxer]",this.reInitSegment=!0,this.reset()}load_webworker(){return new Promise((e,t)=>{this.ob.once("webworker_remuxer_res_init_ok",t=>{e(t?this.worker:null)}),this.worker=new E(this.ob,C)})}destroy(){this.worker&&this.worker.terminate(),this.render&&(this.render.reset(),this.render.destroy(),this.render=null),this.worker=null,this._video=null}check_timestamp(e){this.duration_of_segment!=e&&(this.duration_of_segment=e)}_process_worker_msg(e){switch(e.type){case"remuxed_fmp4_videoframe":this.reInitSegment&&e.initSegment&&(this.reInitSegment=!1),this.render.input_data(e),this._isOperateOver=!0,this.feed_segments()}}input_data(e){if(this._drop_until_wait_i){if(!e.header.is_key_frame)return void this.LOG.WARN("drop it",e.header.frameType,this._raw_videoframes.length);this._drop_until_wait_i=!1}e&&this._raw_videoframes.push(e)}feed_segments(){if(this._isOperateOver&&this.worker){let e=this._raw_videoframes.shift();if(e){this.render.delay<=.4*this.delay_ctrl_vals.normal||this.render.delay<=.8*this.delay_ctrl_vals.normal||this.render.delay<=this.delay_ctrl_vals.normal?this.duration_adjust_val=0:this.render.delay<=1.2*this.delay_ctrl_vals.normal?this.duration_adjust_val=-.5:this.render.delay<=1.5*this.delay_ctrl_vals.normal?this.duration_adjust_val=-1:this.render.delay<=2*this.delay_ctrl_vals.normal&&(this.duration_adjust_val=-2),this.render.delay>1?this.render.playrate=2:this.render.playrate=1;let t=this.duration_of_segment+this.duration_adjust_val;t>100&&(console.warn(this.duration_of_segment,this.duration_adjust_val),t=40),this.pts+=t,this.worker.dispatch({type:"VideoRawFrame",header:e.header,pts:this.pts,duration:t,ar:e.payload,reInitSegment:this.reInitSegment},[e.payload]).then(e=>{this._process_worker_msg(e)}).catch(e=>{console.error(e)}),this._isOperateOver=!1}}}async _process_resolution_changed({codecId:e,width:t,height:r}){this.reset()}_check_delay_and_try_drop(){let e=this._raw_videoframes.length,t=this.render.delay;this.ob.emit("mse_render_info",{delay:t,videoframes:e,pts_adjust_val:this.duration_adjust_val})}start(){}stop(){this.reset()}reset(){this._raw_videoframes=[],this.pts=0,this._isOperateOver=!0,this._drop_until_wait_i=!0,this.render&&this.render.reset(!0),this.reInitSegment=!0}set delay({min:e=.1,normal:t=.5,max:r=1}){t<.25&&(t=.25),this.delay_ctrl_vals={normal:t},this.LOG.WARN("[remuxer]","set delay  to",e,t,r)}create_videoObject(){return this._video=d("video","rendertarget-"+this._name,"\n            position:absolute;\n            left:0;\n            top:0;\n            right:0;\n            bottom:0;\n\n            z-index: 998;\n            background:black;\n            width:100%;\n            height:100%;\n            object-fit:fill;\n        ")}attach(e){if(e){let t=this.create_videoObject();_(e,t,"rendertarget")&&(this._video=t),this.stop(),this.render||(this.render=new k(this.ob)),this.render.attachMedia(this._video)}else this.stop(),this.render&&(this.render.destroy(),this.render=null),this._video=null}capture(){if(this._video){let e=document.createElement("canvas"),t=e.getContext("2d"),r=this._video;return e.width=720,e.height=576,t.drawImage(r,0,0,r.videoWidth,r.videoHeight,0,0,720,576),e}}resize(e,t){this._video&&(this._video.width=e,this._video.height=t)}};class I{constructor(){this.reset(),this.last_st=0}reset(){this.last_vals=0}test(e){if(0==this.last_vals)return this.last_vals=e,40;{let t=(e-this.last_vals)/90;return(t>=1500||t<=10)&&(t=40),this.last_vals=e,t}}}v.install("base-decoder",(function(){let e=this,t=v.LOG;this._decoder_info={_decoder_id:0,_video_width:0,_video_height:0},[{obj:this,k:"CalcDeltaValue",v:new I},{obj:this,k:"Html5Decoder",v:null},{obj:this,k:"FfmpegDecoder",v:null},{obj:this,k:"decoder",v:null}].forEach(({obj:e,k:t,v:r})=>{f(e,t,r)}),this.set_delay=e=>{this.decoder.delay=e},e.capture=()=>this.decoder?this.decoder.capture():null,e.resize=(e,r)=>{if(this.decoder)return t.DEBUG("player resize",e,r),this.decoder.resize(e,r)};const r=r=>{this.decoder._raw_videoframes.splice(0,this.decoder._raw_videoframes.length-1),t.DEBUG("switch_decoder",r);let i=this.decoder._raw_videoframes.concat(),s=this.decoder._drop_until_wait_i;if(this.decoder.stop(),"MSE"==r)this.Html5Decoder||(this.Html5Decoder=new L(e),this.Html5Decoder.load_webworker().then(e=>{this.Html5Decoder._isOperateOver=!0})),this.decoder=this.Html5Decoder,this.decoder.attach(this.rootElement);else{if("FFMPEG"!=r)return void t.ERROR("Unsupported render_type:",r);this.FfmpegDecoder||(this.FfmpegDecoder=new U(e),this.FfmpegDecoder.load_webworker().then(e=>{this.FfmpegDecoder._isOperateOver=!0})),this.decoder=this.FfmpegDecoder,this.decoder.attach(this.rootElement),this.decoder.start()}this.decoder._raw_videoframes=i,this.decoder._drop_until_wait_i=s},i=({header:e,chunk:i,recv:s})=>{if(this.emit("video_frame_info",{header:e,chunk:i,recv:s}),!this._allbytesdropped){switch(e.type){case"video":if(this.decoder.check_timestamp(this.CalcDeltaValue.test(e.frameTimestamp),Math.floor(this.streaminfo.video.fps+.5)),this.decoder.input_data({header:e,payload:i}),e.is_key_frame){let i={codecId:e.video.codecId,width:e.video.vw,height:e.video.vh},{_decoder_id:s,_video_width:n,_video_height:a}=this._decoder_info,o=s!=i.codecId,l=n!=i.width||a!=i.height;if(o){if(t.WARN("[liveplayer]",`codecId:old[${s}] != new[${i.codecId}]`),this.rootElement)if(16==i.codecId){let e=MediaSource.isTypeSupported('video/mp4; codecs="hvc1.1.6.L123"');i.width>720||i.height;if(!e||"MSE"!=this.config.render_type&&"AUTO"!=this.config.render_type){if("AUTO"!=this.config.render_type&&"FFMPEG"!=this.config.render_type)return this.decoder.reset(),-3;r("FFMPEG")}else r("MSE")}else{if(8!=i.codecId)return t.ERROR("[CVH5LivePlayer]","unsupported codec Id:",i.codecId),-3;if("FFMPEG"==this.config.render_type)return this.decoder.reset(),console.error("player_detect_codec_changed"),this.emit("player_detect_codec_changed",this,"avc"),-2;r("MSE")}}else l&&(t.WARN(`resolution:old[${n},${a}] != new[${i.width},${i.height}]`),this.decoder._process_resolution_changed(i));this._decoder_info._decoder_id=i.codecId,this._decoder_info._video_width=i.width,this._decoder_info._video_height=i.height,this.decoder._check_delay_and_try_drop()}this.decoder.feed_segments()}return e}};e.on("ws_data_incoming_video",i);const s=e=>{this.decoder&&this.decoder.attach(e)};e.on("decoder_attach",s);const n=()=>{this.decoder&&this.decoder.stop(),this.CalcDeltaValue.reset()};e.on("abort_request",n);const a=()=>{this.decoder&&this.decoder.start()};e.on("open_request",a),f(e,"_allbytesdropped",!1);const o=({isHidden:e})=>{e?this._allbytesdropped=!0:(this.decoder&&(this.decoder._drop_until_wait_i=!0),this._allbytesdropped=!1)};e.on("player_activate_status_changed",o);const l=()=>{e.off("ws_data_incoming_video",i),e.off("decoder_attach",s),e.off("open_request",a),e.off("abort_request",n),e.off("player_activate_status_changed",o),this.CalcDeltaValue=null,this.FfmpegDecoder&&(this.FfmpegDecoder.destroy(),this.FfmpegDecoder=null),this.Html5Decoder&&(this.Html5Decoder.destroy(),this.Html5Decoder=null),this.decoder=null,this.rootElement&&(this.rootElement.innerHTML=""),e.off("destroy",l)};e.on("destroy",l),"MSE"==this.config.render_type?(this.Html5Decoder=new L(e),this.Html5Decoder.load_webworker().then(e=>{e?(this.decoder=this.Html5Decoder,this.emit("player_ready",{})):(t.ERROR("setup remuxer worker failed! Init Failed!"),this.Html5Decoder&&(this.Html5Decoder.destroy(),this.Html5Decoder=null),this.emit("no_mse_decoder_founded"))})):"FFMPEG"==this.config.render_type?(this.FfmpegDecoder=new U(e),this.FfmpegDecoder.load_webworker().then(e=>{e?(this.decoder=this.FfmpegDecoder,this.emit("player_ready",{})):(t.ERROR("setup decoder worker failed! Init Failed!"),this.FfmpegDecoder&&(this.FfmpegDecoder.destroy(),this.FfmpegDecoder=null),this.emit("no_cv_decoder_founded"))})):"AUTO"==this.config.render_type&&(this.FfmpegDecoder=new U(e),this.Html5Decoder=new L(e),Promise.all([this.FfmpegDecoder.load_webworker(),this.Html5Decoder.load_webworker()]).then(e=>{console.log(e),e[0]||(t.ERROR("setup decoder worker failed! Init Failed!"),this.FfmpegDecoder&&(this.FfmpegDecoder.destroy(),this.FfmpegDecoder=null),this.config.render_type="MSE",this.emit("no_cv_decoder_founded")),e[1]||(t.ERROR("setup remuxer worker failed! Init Failed!"),this.Html5Decoder&&(this.Html5Decoder.destroy(),this.Html5Decoder=null),this.config.render_type="FFMPEG",this.emit("no_mse_decoder_founded")),e.every(e=>!e)?(this.config.render_type="",this.emit("no_any_decoders_founded")):this.Html5Decoder?(this.decoder=this.Html5Decoder,this.emit("player_ready",{})):this.FfmpegDecoder&&(this.decoder=this.FfmpegDecoder,this.emit("player_ready",{}))}))}),["ws-loader"]);var P=class{constructor(e){this.init(e)}init(e){this.option=Object.assign({},{encoding:"16bitInt",channels:1,sampleRate:8e3,flushingTime:320},e),this.samples=new Float32Array,this.flush=this.flush.bind(this),this.bufferedTime=0,this.maxValue=this.getMaxValue(),this.typedArray=this.getTypedArray(),this.createContext()}getMaxValue(){let e={"8bitInt":128,"16bitInt":32768,"32bitInt":2147483648,"32bitFloat":1};return e[this.option.encoding]?e[this.option.encoding]:e["16bitInt"]}getTypedArray(){let e={"8bitInt":Int8Array,"16bitInt":Int16Array,"32bitInt":Int32Array,"32bitFloat":Float32Array};return e[this.option.encoding]?e[this.option.encoding]:e["16bitInt"]}createContext(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=1,this.gainNode.connect(this.audioCtx.destination),this.startTime=this.audioCtx.currentTime}isTypedArray(e){return e.byteLength&&e.buffer&&e.buffer.constructor==ArrayBuffer}feed(e){if(!this.isTypedArray(e))return;this.bufferedTime+=40,e=this.getFormatedValue(e);let t=new Float32Array(this.samples.length+e.length);t.set(this.samples,0),t.set(e,this.samples.length),this.samples=t,this.flush()}getFormatedValue(e){e=new this.typedArray(e.buffer);let t,r=new Float32Array(e.length);for(t=0;t<e.length;t++)r[t]=e[t]/this.maxValue;return r}get volumne(){return this.gainNode.gain.value}set volumne(e){this.gainNode.gain.value=e}destroy(){this.interval&&clearInterval(this.interval),this.samples=null,this.audioCtx.close(),this.audioCtx=null}flush(){if(!this.samples.length||this.bufferedTime<this.option.flushingTime)return;this.bufferedTime=0;let e,t,r,i,s,n=this.audioCtx.createBufferSource(),a=this.samples.length/this.option.channels,o=this.audioCtx.createBuffer(this.option.channels,a,this.option.sampleRate);for(t=0;t<this.option.channels;t++)for(e=o.getChannelData(t),r=t,s=50,i=0;i<a;i++)e[i]=this.samples[r],i<50&&(e[i]=e[i]*i/50),i>=a-51&&(e[i]=e[i]*s--/50),r+=this.option.channels;this.startTime<this.audioCtx.currentTime&&(this.startTime=this.audioCtx.currentTime),n.buffer=o,n.connect(this.gainNode),n.start(this.startTime),this.startTime+=o.duration,this.samples=new Float32Array}};const M={TP_ALAW:0,TP_ULAW:1},F=new Uint16Array([255,511,1023,2047,4095,8191,16383,32767]);new Uint8Array([1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,27,29,31,33,34,35,36,37,38,39,40,41,42,43,44,46,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128]),new Uint8Array([1,3,5,7,9,11,13,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,32,33,33,34,34,35,35,36,37,38,39,40,41,42,43,44,45,46,47,48,48,49,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127]);function G(e,t,r){let i=0;for(i=0;i<r;i++)if(e<=t[i])return i;return r}function N(e){let t,r,i;return e>=0?t=213:(t=85,e=-e-8),r=G(e,F,8),r>=8?127^t:(i=r<<4,i|=r<2?e>>4&15:e>>r+3&15,i^t)}function j(e){let t,r;switch(t=(15&(e^=85))<<4,r=(112&e)>>4,r){case 0:t+=8;break;case 1:t+=264;break;default:t+=264,t<<=r-1}return 128&e?t:-t}function V(e){let t,r,i;return e<0?(e=132-e,t=127):(e+=132,t=255),r=G(e,F,8),r>=8?127^t:(i=r<<4|e>>r+3&15,i^t)}function B(e){let t;return t=132+((15&(e=~e))<<3),t<<=(112&e)>>4,128&e?132-t:t-132}var W={g711_decode:function(e,t){let r=new Uint16Array(e.length),i=e.length,s=0;if("[object Uint8Array]"!==Object.prototype.toString.call(e))return r;if(0==i)return r;if(M.TP_ALAW==t)for(s=0;s<i;s++)r[s]=j(e[s]);else for(s=0;s<i;s++)r[s]=B(e[s]);return r},g711_encode:function(e,t){let r=new ArrayBuffer(320),i=e.length,s=0,n=Object.prototype.toString.call(e);if("[object Int16Array]"!==n&&"[object Uint16Array]"!==n)return r;if(0==i)return r;let a=new DataView(e.buffer),o=new DataView(r);if(M.TP_ALAW==t)for(s=0;s<i;s++)o.setInt8(s,N(a.getInt16(2*s,!0)));else for(s=0;s<i;s++)o.setInt8(s,V(a.getInt16(2*s,!0)),!0);return r},G711_TYPE:M};var H=class{constructor(){this.LOG=v.LOG,this._audio_flg=!1,this.frame_list=[],this.DecodeEnd=!0,this.pcmplayer=null}get ready(){return!0}_feed_g711u_to_decode(){if(this.DecodeEnd)if(0==this.frame_list.length);else{let e=this.frame_list.shift(),t=W.g711_decode(new Uint8Array(e),W.G711_TYPE.TP_ULAW);this.pcmplayer&&t.length>0&&this.pcmplayer.feed(new Uint8Array(t.buffer))}}input_g711udata(e){this._audio_flg&&(this.frame_list.push(e),this.DecodeEnd=!0,this._feed_g711u_to_decode())}stop(){this.LOG.WARN("voice flg",this._audio_flg),this.frame_list=[],this.DecodeEnd=!0}destroy(){this.pcmplayer&&(this.pcmplayer.destroy(),this.pcmplayer=null)}get volumne(){return this.pcmplayer||(this.pcmplayer=new P),this.pcmplayer.volumne}set volumne(e){0==e?(this._audio_flg=!1,this.stop()):this._audio_flg=!0,this.pcmplayer||(this.pcmplayer=new P),this.pcmplayer.volumne=e}};v.install("audio-decoder",(function(){let e=this;v.LOG;f(this,"audio_decoder",new H);const t=({header:e,chunk:t,recv:r})=>{this.audio_decoder.input_g711udata(t.slice(36))};e.on("ws_data_incoming_audio",t);const r=()=>{this.audio_decoder.stop()};e.on("abort_request",r),e.get_volumne=()=>this.audio_decoder.volumne,e.set_volumne=e=>{e=parseFloat(e),Object.is(e,NaN)||(e<0?e=0:e>1&&(e=1),this.audio_decoder.volumne=e,this.emit("player_status_msg",{voice_status:0!=e}))};const i=()=>{this.audio_decoder.stop(),this.audio_decoder.destroy(),this.audio_decoder=null,e.off("ws_data_incoming_audio",t),e.off("abort_request",r),e.off("destroy",i)};e.on("destroy",i)}),[]);const Y="#00FF00",q="#FF0000",z="#0000FF";class X{constructor(e=Y,t=25){this._draw_color=e,this._clear_delay=t,this._data_map=new Map,this._renderMask=null}set_blink_flag(e,t){if(this._data_map.has(e)){let r=this._data_map.get(e);r.blink_tid&&(clearTimeout(r.blink_tid),r.blink_tid=0),t&&(r.blink_tid=setTimeout(()=>{r.blink_flg=!1,r.last_blink_st=0},500)),r.blink_flg=t}}set(e){this._data_map.set(e.node_id,{tid:0,nodeData:e,blink_color:[q,this._draw_color],rever_cnt:1,blink_tid:0,blink_flg:!1})}draw(){if(this._renderMask){let e=[],t=[];for(let[r,i]of this._data_map){let r=this._draw_color;i.blink_flg&&(i.rever_cnt++%30==0&&(i.blink_color.push(i.blink_color.shift()),i.rever_cnt=1),r=i.blink_color[0]),i.nodeData.draw_color=r,i.tid<this._clear_delay?(e.push(i.nodeData),i.tid++):t.push(i.nodeData.node_id)}e.length&&this._renderMask.DrawSmart(e,this._draw_color),t.forEach(e=>{this._data_map.delete(e)})}}attach(e){this._renderMask=e}}class J{constructor(e=z,t=5){this._draw_color=e,this._clear_delay=t,this._data_map=new Map,this._renderMask=null}set(e){Array.isArray(e)&&this._data_map.set(e.node_id,{nodeData:e,show_cnt:0})}draw(){if(this._renderMask){let e=[],t=[];for(let[r,i]of this._data_map)if(i.show_cnt>this._clear_delay)t.push(r);else{i.show_cnt++;for(let t of i.nodeData)e.push(t)}e.length&&this._renderMask.DrawSmart(e,this._draw_color),t.forEach(e=>{this._data_map.delete(e)})}}attach(e){this._renderMask=e}}class K extends J{constructor(e=z,t=5){super(e,t)}set(e){try{if(Array.isArray(e))for(let t of e)t.show_cnt=this._clear_delay,this._data_map.set(t.id,JSON.parse(JSON.stringify(t)))}catch(t){LOG.ERROR(t,e)}}draw(e){if(this._renderMask){let t=[],r=[];for(let[e,i]of this._data_map)i.show_cnt--,i.show_cnt>=0?t.push(i):r.push(e);for(let e of r)this._data_map.delete(e);t.length&&this._renderMask.DrawSmart(t,this._draw_color,e)}}}class Q extends J{constructor(e=z,t=250){super(e,t)}set(e){try{if(Array.isArray(e))for(let t of e)t.show_cnt=this._clear_delay,this._data_map.set(t.id,JSON.parse(JSON.stringify(t)))}catch(t){LOG.ERROR(t,e)}}draw(e){if(this._renderMask){let t=[],r=[];for(let[e,i]of this._data_map)i.show_cnt--,i.show_cnt>=0?t.push(i):r.push(e);for(let e of r)this._data_map.delete(e);t.length&&this._renderMask.DrawSmart(t,this._draw_color,e)}}}function Z(e,t){let r={x:0,y:0,w:0,h:0},i=0,s=1,n=t;return i=e.getUint16(n,!0),n+=2,s=e.getUint16(n,!0),r.x=i/s,n+=2,i=e.getUint16(n,!0),n+=2,s=e.getUint16(n,!0),r.y=i/s,n+=2,i=e.getUint16(n,!0),n+=2,s=e.getUint16(n,!0),r.w=i/s,n+=2,i=e.getUint16(n,!0),n+=2,s=e.getUint16(n,!0),r.h=i/s,r}var ee=class{constructor(){this.fn={1:["ivs_counter_rule","ivs_counter_result"],2:["ivs_wire_rule","ivs_wire_result"],3:["ivs_region_rule","ivs_region_result"],4:["ivs_region_rule","ivs_region_result"],7:["ivs_face_rule","ivs_face_result"],8:["","ivs_fire_result"],10:["","ivs_domeTrack_result"],12:["ivs_retrograde_rule","ivs_wire_result"],13:["ivs_highdensity_rule","ivs_wire_result"],14:["ivs_highdensity_rule","ivs_wire_result"],15:["ivs_wire_rule","ivs_wire_result"],18:["","ivs_person_result"],19:["ivs_highdensity_rule","ivs_absent_result"],20:["ivs_region_rule","ivs_region_result"],21:["ivs_helmet_rule","ivs_helmet_result"],22:["ivs_region_rule","ivs_region_result"],23:["","ivs_dometrack_resultV2"],100:["","ivs_traffic_result"]}}decode_data(e,t,r,i,s){if(this.fn[t]&&this.fn[t][e-27].length>0){let n=[1,12,19].includes(t)&&1==r||3==t&&2==r,a=this.fn[t][e-27];return this[a]?this[a](i,s,n):(console.error("decode_data/ has no function ===>",a),{})}return console.error("unsupported ","frametype is ",e,"type is ",t,"version is ",r),{}}decode_node(e,t){let r=e.getUint32(t,!0);if(t+=4,320116008!=r)return null;let i=e.getUint32(t,!0);t+=4;let s=e.getUint32(t,!0);t+=4;let n=e.getUint32(t,!0);t+=4;let a=e.getUint32(t,!0);return t+=4,{magic:r,version:i,id:s,datalen:n,type:a}}parse_arrow(e,t){let r={},i=t;r.mask=e.getUint32(i,!0),i+=4;let s=0;r.points=[];let n,a,o=[];for(;s<10;)n=e.getUint32(i,!0),i+=4,a=e.getUint32(i,!0),r.points[s]={},r.points[s].x=n/a,i+=4,n=e.getUint32(i,!0),i+=4,a=e.getUint32(i,!0),r.points[s].y=n/a,i+=4,r.mask&1<<s&&s>0&&o.push([r.points[s<6?0:1],r.points[s]]),s++;return o}ivs_counter_rule(e,t){let r=t+88,i=this.parse_arrow(e,r);r=t+252;let s=e.getUint32(r,!0);r+=4;let n=e.getUint32(r,!0);if(r=n,320116008!=e.getUint32(n,!0))return{};let a,o,l=[];for(let t=0;t<s;t++)r+=4,a=e.getUint32(r,!0),r+=4,o=e.getUint32(r,!0),l[t]={},l[t].x=a/o,r+=4,a=e.getUint32(r,!0),r+=4,o=e.getUint32(r,!0),l[t].y=a/o;return{points:l,arrow:i}}ivs_counter_result(e,t,r){let i=t+8,s=e.getInt32(i,!0);i+=4;let n=e.getInt32(i,!0);i+=4;let a=e.getInt32(i,!0);i+=4;let o=e.getInt32(i,!0);i+=4;let l=e.getInt32(i,!0);i+=4;let c=e.getInt32(i,!0);i+=4;let h,d,u=e.getUint32(i,!0),_={};return i+=4,h=e.getUint32(i,!0),i+=4,d=e.getUint32(i,!0),_.x=h/d,i+=4,h=e.getUint32(i,!0),i+=4,d=e.getUint32(i,!0),_.y=h/d,[{total_enable:s,real_rate_enable:n,total_count:a,real_count:o,total_alarm_num:l,rate_alarm_num:c,is_need_alarm:u,point:_,begin_end_lineto:!1}]}ivs_wire_rule(e,t){let r=t+40,i=this.parse_arrow(e,r);r+=164;let s=e.getUint32(r,!0);r+=4;let n=e.getUint32(r,!0);if(r=n,320116008!=e.getUint32(n,!0))return{};let a=[],o=0,l=0,c=0;for(o=0;o<s;o++)r+=4,l=e.getUint32(r,!0),r+=4,c=e.getUint32(r,!0),a[o]={},a[o].x=l/c,r+=4,l=e.getUint32(r,!0),r+=4,c=e.getUint32(r,!0),a[o].y=l/c;return{begin_end_lineto:!1,points:a,arrow:i}}ivs_retrograde_rule(e,t){let r=this.ivs_wire_rule(e,t);return r.begin_end_lineto=!0,r}ivs_wire_result(e,t,r){let i=t+4,s=e.getUint32(i,!0);i+=4;let n=e.getUint32(i,!0);if(i=n,320116008!==e.getUint32(n,!0))return{};let a,o,l=[];for(let t=0;t<s;t++){let t={rect:{}};i+=4,a=e.getUint32(i,!0),i+=4,o=e.getUint32(i,!0),t.rect.x=a/o,i+=4,a=e.getUint32(i,!0),i+=4,o=e.getUint32(i,!0),t.rect.y=a/o,i+=4,a=e.getUint32(i,!0),i+=4,o=e.getUint32(i,!0),t.rect.w=a/o,i+=4,a=e.getUint32(i,!0),i+=4,o=e.getUint32(i,!0),t.rect.h=a/o,l.push(t)}if(r){i=n+4+32*s;for(let t=0;t<s;t++)l[t].result_id=e.getUint32(i,!0),i+=4;i=n+4+32*s+4*s;for(let t=0;t<s;t++)l[t].result_type=e.getUint32(i,!0),i+=4}return l}ivs_region_rule(e,t){let r=t+180,i=e.getUint32(r,!0);r+=4;let s=e.getUint32(r,!0);if(r=s,320116008!=e.getUint32(s,!0))return console.error("region rule vertex cnt",i),{};let n,a,o=[];for(let t=0;t<i;t++)r+=4,n=e.getUint32(r,!0),r+=4,a=e.getUint32(r,!0),o[t]={},o[t].x=n/a,r+=4,n=e.getUint32(r,!0),r+=4,a=e.getUint32(r,!0),o[t].y=n/a;return i>0&&o.push(o[0]),{points:o,begin_end_lineto:!0}}ivs_region_result(e,t,r){let i=t+8,s=e.getUint32(i,!0);i+=4;let n=e.getUint32(i,!0);if(i=n,320116008!=e.getUint32(n,!0))return console.error("region result vertex cnt",vertex_cnt),{};let a,o,l=[];for(let t=0;t<s;t++){let t={rect:{}};i+=4,a=e.getUint32(i,!0),i+=4,o=e.getUint32(i,!0),t.rect.x=a/o,i+=4,a=e.getUint32(i,!0),i+=4,o=e.getUint32(i,!0),t.rect.y=a/o,i+=4,a=e.getUint32(i,!0),i+=4,o=e.getUint32(i,!0),t.rect.w=a/o,i+=4,a=e.getUint32(i,!0),i+=4,o=e.getUint32(i,!0),t.rect.h=a/o,l.push(t)}if(r){i=n+4+32*s;for(let t=0;t<s;t++)l[t].result_id=e.getUint32(i,!0),i+=4;i=n+4+32*s+4*s;for(let t=0;t<s;t++)l[t].result_type=e.getUint32(i,!0),i+=4}return l}ivs_highdensity_rule(e,t){let r=t+8,i=e.getUint32(r,!0);r+=4;let s=e.getUint32(r,!0);if(r=s,320116008!=e.getUint32(s,!0))return{};let n,a,o=[];for(let t=0;t<i;t++)r+=4,n=e.getUint32(r,!0),r+=4,a=e.getUint32(r,!0),o[t]={},o[t].x=n/a,r+=4,n=e.getUint32(r,!0),r+=4,a=e.getUint32(r,!0),o[t].y=n/a;return i>0&&o.push(o[0]),{points:o,begin_end_lineto:!1}}ivs_helmet_rule(e,t){let r=t+24,i=e.getUint32(r,!0);r+=4;let s=e.getUint32(r,!0);if(r=s,320116008!=e.getUint32(s,!0))return console.error("helmet  rule vertex cnt",i),{};let n,a,o=[];for(let t=0;t<i;t++)r+=4,n=e.getUint32(r,!0),r+=4,a=e.getUint32(r,!0),o[t]={},o[t].x=n/a,r+=4,n=e.getUint32(r,!0),r+=4,a=e.getUint32(r,!0),o[t].y=n/a;return i>0&&o.push(o[0]),{points:o,begin_end_lineto:!0}}ivs_helmet_result(e,t){let r=t+4,i=e.getUint32(r,!0);r+=4;let s=e.getUint32(r,!0);if(r=s,320116008!=e.getUint32(s,!0))return{};let n,a,o=[];r+=4;for(let t=0;t<i;t++){let i=r+52*t;n=e.getUint16(i,!0),i+=2,a=e.getUint16(i,!0);let s={rect:{}};s.rect.x=n/a,i+=2,n=e.getUint16(i,!0),i+=2,a=e.getUint16(i,!0),s.rect.y=n/a,i+=2,n=e.getUint16(i,!0),i+=2,a=e.getUint16(i,!0),s.rect.w=n/a,i+=2,n=e.getUint16(i,!0),i+=2,a=e.getUint16(i,!0),s.rect.h=n/a,i+=18,s.helmet_status=e.getInt32(i,!0),o.push(s)}return o}ivs_domeTrack_result(e,t){let r,i,s=t;r=e.getUint32(s,!0),s+=4,i=e.getUint32(s,!0);let n={rect:{}};return n.rect.x=r/i,s+=4,r=e.getUint32(s,!0),s+=4,i=e.getUint32(s,!0),n.rect.y=r/i,s+=4,r=e.getUint32(s,!0),s+=4,i=e.getUint32(s,!0),n.rect.w=r/i,s+=4,r=e.getUint32(s,!0),s+=4,i=e.getUint32(s,!0),n.rect.h=r/i,[]}ivs_fire_result(e,t){let r=t,i=e.getUint32(r,!0);r+=4;let s=e.getUint32(r,!0);if(r=s,320116008!=e.getUint32(s,!0))return{};let n,a,o=[];r+=4;for(let t=0;t<i;t++)n=e.getUint16(r,!0),r+=2,a=e.getUint16(r,!0),o[t]={},o[t].x=n/a,r+=2,n=e.getUint16(r,!0),r+=2,a=e.getUint16(r,!0),o[t].y=n/a,r+=2,n=e.getUint16(r,!0),r+=2,a=e.getUint16(r,!0),o[t].w=n/a,r+=2,n=e.getUint16(r,!0),r+=2,a=e.getUint16(r,!0),o[t].h=n/a;return o.map((e,t)=>({rect:e}))}ivs_person_result(e,t){let r=t-16,i=e.getUint32(r,!0);r=20;let s=e.getUint32(r,!0);switch(r=t,i){case 0:case 200:{let t=e.getUint32(r,!0);r+=4;let i=e.getUint32(r,!0);if(i>s+36)return{};if(320116008!=e.getUint32(i,!0))return{};let n,a,o=[];r=i+4;for(let s=0;s<t;s++){let t=i+24*(s+1),l=e.getUint32(t,!0);if(-1==l)continue;t-=4;let c=e.getUint32(t,!0);n=e.getUint16(r,!0),r+=2,a=e.getUint16(r,!0);let h={};h.x=n/a,r+=2,n=e.getUint16(r,!0),r+=2,a=e.getUint16(r,!0),h.y=n/a,r+=2,n=e.getUint16(r,!0),r+=2,a=e.getUint16(r,!0),h.w=n/a,r+=2,n=e.getUint16(r,!0),r+=2,a=e.getUint16(r,!0),h.h=n/a,o.push({rect:h,id:l,score:c}),r=t+8}return o}}return{}}ivs_absent_result(e,t){return{}}ivs_face_rule(e,t){let r,i,s=t+12,n=e.getUint32(s,!0);if(s=n,320116008!=e.getUint32(n,!0))return{};s+=4;let a={};return r=e.getUint16(s,!0),s+=2,i=e.getUint16(s,!0),a.x=r/i,s+=2,r=e.getUint16(s,!0),s+=2,i=e.getUint16(s,!0),a.y=r/i,s+=2,r=e.getUint16(s,!0),s+=2,i=e.getUint16(s,!0),a.w=r/i,s+=2,r=e.getUint16(s,!0),s+=2,i=e.getUint16(s,!0),a.h=r/i,{begin_end_lineto:!0,points:[{x:a.x,y:a.y},{x:a.x+a.w,y:a.y},{x:a.x+a.w,y:a.y+a.h},{x:a.x,y:a.y+a.h}]}}async ivs_face_result(e,t){let r=t-16,i=e.getUint32(r,!0);r=20;let s=e.getUint32(r,!0);r=16;let n=e.getUint32(r,!0);switch(r=t,i){case 0:case 100:case 200:case 205:case 206:{e.getUint32(r,!0);r+=4;let t=e.getUint32(r,!0);r+=4;e.getUint32(r,!0);r+=4;let a=e.getUint32(r,!0);r+=4;let o=e.getUint32(r,!0);r+=4;e.getUint32(r,!0);r+=4;e.getUint32(r,!0);if(t>s+36)return{};if(320116008!=e.getUint32(t,!0))return{};let l={};if(o>0){let s=a+4,c=new DataView(e.buffer,s,o-4);if(l={capture_time:n,FaceCaptureBase64:await this.get_data_base64(c)},r=t+4,i>=100){r+=56;let t=e.getInt32(r,!0)/10;r+=4;let i=e.getInt32(r,!0);$.extend(l,{score:t,id:i})}if(i>=205){r+=4;let t=e.getInt32(r,!0);$.extend(l,{helmet_type:t})}if(i>=206){r+=4;let t=e.getInt32(r,!0);r+=4;let i=e.getFloat32(r,!0);r+=4;let s=e.getInt32(r,!0);r+=4;let n=e.getInt32(r,!0);$.extend(l,{temp_type:t,temp:i,temp_valid:s,emask:n})}return l}return{}}case 202:{r+=4;let t=e.getUint32(r,!0);if(t>s+36)return{};if(320116008!=e.getUint32(t,!0))return{};r+=8;e.getUint32(r,!0);r+=4;e.getUint32(r,!0)}break;case 201:return{};case 300:case 301:case 302:{let t=e.getUint32(r,!0);r+=4;let n=e.getUint32(r,!0);r+=4;let a=e.getUint32(r,!0);r+=4;let o=e.getUint32(r,!0);r+=4;let l=e.getUint32(r,!0);r+=4;let c=e.getUint32(r,!0);r+=4;let h,d=e.getUint32(r,!0);if(r+=4,n+a>s+36||o+l>s+36||c+d>s+36){console.error("Face Result Data Overflow!");break}if(0==t||a<=4)return[];if(320116008!=e.getUint32(n,!0))return console.error("Invalid magic!"),[];if(l>4){if(alert(l),320116008!=e.getUint32(o,!0))return console.error("Invalid magic!"),[];(function(e,t,r){let i=0;if(r<i+2)return console.error("error buffer size ",r),null;let s={w:0,h:0},n=0;if(n=e.getUint16(t+i,!1),i+=2,65496!=n)return console.error("invalid jpg start id!"),{};for(;i<r;){let n=0,a=0;if(r<i+2)break;if(n=e.getUint16(t+i,!1),i+=2,n<65535&&n>=65504||65499==n||65476==n||65501==n||65498==n){if(r<i+2)break;a=e.getUint16(t+i,!1),i+=a}else{if(65497==n)break;if(65472==n){if(r<i+2)break;if(a=e.getUint16(t+i,!1),r<i+a||a<7)break;return s.h=e.getUint16(t+i+3,!1),s.w=e.getUint16(t+i+5,!1),s}}}return{}})(e,o+4,l-4)=={}&&console.error("Face Result Include Invalid jpeg data!");let t=new DataView(e.buffer,o+4,l-4);h=await this.get_data_base64(t)}let u=[];r=n+4;for(let s=0;s<t;s++){let t={};t.rect=Z(e,r),r+=16,i>=301&&(r+=16);let s,n,a=[];for(let t=0;t<10;t++)s=e.getUint16(r,!0),r+=2,n=e.getUint16(r,!0),r+=2,a.push(s/n);t.shape=a,t.score=e.getInt32(r,!0)/10,r+=4,t.id=e.getInt32(r,!0),r+=4,t.liveness=0!=e.getInt32(r,!0),r+=4,u.push(t)}return u}default:console.error("unsupported node version",i)}return{}}async ivs_traffic_result(e,t){let r=t-16,i=e.getUint32(r,!0);r=t-4;let s=e.getUint32(r,!0);r=20;let n=e.getUint32(r,!0)+36;r=16;let a=e.getUint32(r,!0);if(r=t,r+s>n)return{};switch(i){case 0:case 1:{if(s<60)return console.error("Smart Node data len too short!"),{};let t=function(e,t){let r={traffic_type:0,start_seek:0,data_len:0,pic_start_seek:0,pic_data_len:0,featureData_start_seek:0,featureData_data_len:0,modal_start_seek:0,modal_data_len:0};return r.traffic_type=e.getInt32(t,!0),t+=4,r.start_seek=e.getInt32(t,!0),t+=4,r.data_len=e.getInt32(t,!0),t+=4,r.pic_start_seek=e.getInt32(t,!0),t+=4,r.pic_data_len=e.getInt32(t,!0),t+=4,r.featureData_start_seek=e.getInt32(t,!0),t+=4,r.featureData_data_len=e.getInt32(t,!0),t+=4,r.modal_start_seek=e.getInt32(t,!0),t+=4,r.modal_data_len=e.getInt32(t,!0),t+=4,r}(e,r);if(t.start_seek+t.data_len>n||t.pic_start_seek+t.pic_data_len>n||t.featureData_start_seek+t.featureData_data_len>n)return console.error("Traffic result data overflow!"),{};if(t.data_len<=4){console.error("Traffic result info error!");break}if(r=t.start_seek,320116008!=e.getUint32(t.start_seek,!0))return console.error("Magic error!"),{};r+=4;Z(e,r);r+=16;let o,l,c=[];for(let t=0;t<10;t++)o=e.getUint16(r,!0),r+=2,l=e.getUint16(r,!0),r+=2,c.push(o/l);e.getInt32(r,!0);r+=4;e.getInt32(r,!0);r+=4;let h=t.traffic_type,d={face_id:"",name:"",describe:"",grp_name:"",type:0},u={name:"",id:"",gender:"",national:"",address:"",maker:"",birthday:0,start_date:0,end_data:0},_={usr_name:""},f={englishName:"",gender:"",id:"",areaCode:"",chineseName:"",start_date:0,end_date:0,birthday:0,versionNumber:"",officeNumber:"",cardType:""},m={name:"",gender:"",birthday:0,address:"",id:"",maker:"",start_date:0,end_date:0,passNumber:"",lssueTimes:0,cardType:""},p=r,g=0;switch(t.traffic_type){case 1:case 2:g=64,d.face_id=await this.get_string(e,p,g),p+=g,g=64,d.name=await this.get_string(e,p,g),p+=g,g=64,d.describe=await this.get_string(e,p,g),p+=g,g=64,d.grp_name=await this.get_string(e,p,g),p+=g,d.type=e.getInt32(e,p),p+=4;break;case 4:g=30,u.name=await this.get_string(e,p,g),p+=g,g=4,u.gender=await this.get_string(e,p,g),p+=g,g=32,u.national=await this.get_string(e,p,g),p+=g,u.birthday=e.getInt32(e,p),p+=4,g=70,u.address=await this.get_string(e,p,g),p+=g,g=36,u.id=await this.get_string(e,p,g),p+=g,g=30,u.maker=await this.get_string(e,p,g),p+=g,u.start_date=e.getInt32(e,p),p+=4,u.end_date=e.getInt32(e,p),p+=4;case 8:_.usr_name=await this.get_string(e,of_temp,32),p+=32;break;case 16:f.englishName=await this.get_string(e,p,120),p+=120,f.gender=await this.get_string(e,p,4),p+=4,f.id=await this.get_string(e,p,30),p+=30,f.areaCode=await this.get_string(e,p,12),p+=12,f.chineseName=await this.get_string(e,p,30),p+=30,f.start_date=e.getUint32(p),p+=4,f.end_date=e.getUint32(p),p+=4,f.birthday=e.getUint32(p),p+=4,f.versionNumber=await this.get_string(e,p,8),p+=8,f.officeNumber=await this.get_string(e,p,16),p+=16,f.cardType=await this.get_string(e,p,4),p+=4,p+=36;break;case 32:m.name=await this.get_string(e,p,30),p+=30,m.gender=await this.get_string(e,p,4),p+=4,p+=4,m.birthday=e.getUint32(p),r+=4,m.address=await this.get_string(e,p,70),p+=70,m.id=await this.get_string(e,p,70),p+=36,m.maker=await this.get_string(e,p,70),p+=30,m.start_date=e.getUint32(p),p+=4,m.end_date=e.getUint32(p),p+=4,m.passNumber=await this.get_string(e,p,18),p+=18,m.lssueTimes=e.getUint32(p),p+=4,p+=6,m.cardType=await this.get_string(e,p,4),p+=4,p+=6;break;case 128:break;case 64:case 512:case 1024:break;default:console.error("Unsupport traffic type!")}r+=1==i?484:272;let v=e.getInt32(r,!0);r+=4;let y=e.getInt32(r,!0);(y<0||y>5)&&(y=0),r+=4;let w=e.getFloat32(r,!0);r+=4;let b=!!e.getInt32(r,!0);r+=4;let R=e.getInt32(r,!0);r+=4;let E=e.getUint32(r,!0);r+=4;let U=e.getUint32(r,!0);r+=4;let x=E<<32|U,A=e.getUint32(r,!0);r+=4;let O,S,T=e.getUint32(r,!0);if(r+=4,t.pic_data_len>4){let r=new DataView(e.buffer,t.pic_start_seek+4,t.pic_data_len-4);O=await this.get_data_base64(r)}let D=!1;if(t.modal_data_len>4){let r=new DataView(e.buffer,t.modal_start_seek+4,t.modal_data_len-4);S=await this.get_data_base64(r),D=!0}let k={PictureBase64:O,IdentifyBase64:S,have_modal:D,capture_time:a,similarity:v,temp_type:y,temp:w,temp_valid:b,emask:R,card_id:x,magic:A,open_type:h,normal_info:d,identity_info:u};return 1==i&&$.extend(k,{is_open:T}),k}}return{}}get_data_text(e,t="utf-8"){return new Promise((r,i)=>{let s=new FileReader,n=new Uint8Array(e);s.readAsText(new Blob([n]),t),s.onload=function(){r(s.result)}})}get_data_base64(e){return new Promise((t,r)=>{let i=new FileReader;i.readAsDataURL(new Blob([e],{type:"image/jpeg"})),i.onload=function(){t(i.result)}})}async get_string(e,t,r){let i=0,s=[],n=t;for(;i<r;){let t=e.getUint8(n,!0);n++,i++,0!=t&&s.push(t)}return await this.get_data_text(s)}async ivs_plate_result(e,t){let r=t,i=e.getUint32(r,!0);r+=4;let s=e.getUint32(r,!0);r+=8;let n=e.getUint32(r,!0);r+=4;let a=e.getUint32(r,!0);if(r=s,320116008!=e.getUint32(s,!0))return{};let o,l,c=[];r+=4;let h,d=0,u=[];for(d=0;d<i;d++){o=e.getUint16(r,!0),r+=2,l=e.getUint16(r,!0),c[d]={},c[d].x=o/l,r+=2,o=e.getUint16(r,!0),r+=2,l=e.getUint16(r,!0),c[d].y=o/l,r+=2,o=e.getUint16(r,!0),r+=2,l=e.getUint16(r,!0),c[d].w=o/l,r+=2,o=e.getUint16(r,!0),r+=2,l=e.getUint16(r,!0),c[d].h=o/l,r+=2;let t=e.getUint32(r,!0);r+=12,d=0;let i=[];for(;d<12;){let t=e.getUint8(r,!0);r+=1,d++,0!=t&&i.push(t)}let s=await this.get_data_text(i,"gbk");u.push({rect:c,extData:{color:t,license:s}})}if(a>0){let t=new DataView(e.buffer,n,a);h=await this.get_data_base64(t),u.push({rect:[],extData:{PlateCaptureBase64:h}})}return u}ivs_dometrack_resultV2(e,t){let r=t+4,i=e.getUint32(r,!0);r+=4;let s=e.getUint32(r,!0);if(r=s,320116008!=e.getUint32(s,!0))return{};let n,a,o=[];r+=4;for(let t=0;t<i;t++){let i=r+60*t,s={rect:{},id:-1,is_tracked:-1,type:-1};s.id=e.getUint32(i,!0),i+=4,s.is_tracked=e.getUint32(i,!0),i+=4,n=e.getUint16(i,!0),i+=2,a=e.getUint16(i,!0),s.rect.x=n/a,i+=2,n=e.getUint16(i,!0),i+=2,a=e.getUint16(i,!0),s.rect.y=n/a,i+=2,n=e.getUint16(i,!0),i+=2,a=e.getUint16(i,!0),s.rect.w=n/a,i+=2,n=e.getUint16(i,!0),i+=2,a=e.getUint16(i,!0),s.rect.h=n/a,i+=2,s.type=e.getInt32(i,!0),o.push(s)}return o}},te=r(6),re=r.n(te);var ie=class{constructor(e){this._ob=e,this.LOG=v.LOG,this._mask=null,this._drawCtx=new y("smart",25),this._rules_map=new Map,this._results_map=new Map,this.canvas_s=null,this._enable_smartresult=!1,this._enable_smartrule=!1,this._startegy_faceonly=!1,this._draw_extrainfo=!1,this.drop_everything=!1,this._decoder=new ee,this.bind_dealers(),this.tempMapArea=null,this._hasStart=!1}get ready(){return!0}bind_dealers(){this._rules_map.set(1,new X(Y,75)),this._rules_map.set(2,new X(Y,75)),this._rules_map.set(3,new X(Y,75)),this._rules_map.set(4,new X(Y,75)),this._rules_map.set(7,new X(Y,75)),this._rules_map.set(12,new X(Y,75)),this._rules_map.set(13,new X(Y,75)),this._rules_map.set(14,new X(Y,75)),this._rules_map.set(15,new X(Y,75)),this._rules_map.set(19,new X(Y,75)),this._rules_map.set(20,new X(Y,75)),this._rules_map.set(21,new X(Y,75)),this._rules_map.set(22,new X(Y,75)),this._results_map.set(1,new J(q,20)),this._results_map.set(2,new J(z,5)),this._results_map.set(3,new J(z,5)),this._results_map.set(4,new J(z,5)),this._results_map.set(7,new Q(z,5)),this._results_map.set(8,new J(z,5)),this._results_map.set(12,new J(z,5)),this._results_map.set(13,new J(z,5)),this._results_map.set(14,new J(z,5)),this._results_map.set(15,new J(z,5)),this._results_map.set(18,new J(z,5)),this._results_map.set(19,new J(z,5)),this._results_map.set(20,new J(z,5)),this._results_map.set(21,new J(z,5)),this._results_map.set(22,new J(z,5)),this._results_map.set(23,new K(z,5))}set_smart_rule(e){if(!this._startegy_faceonly&&this._mask&&this._enable_smartrule)try{if(e.frameData.length>0)for(let t of e.frameData)this._rules_map.has(t.smart_type)?this._rules_map.get(t.smart_type).set(t):this.LOG.ERROR("not supported type rule: "+t.smart_type)}catch(e){this.LOG.ERROR(e)}}set_smart_result(e){if(this._mask&&this._enable_smartresult&&e.frameData.length>0)for(let t of e.frameData)if(!this._startegy_faceonly||7==t.smart_type)if(this._results_map.has(t.smart_type)){this._results_map.get(t.smart_type).set(t,e.header.frameTimestamp);try{this._rules_map.has(t.smart_type)&&(1==t.smart_type?this._rules_map.get(t.smart_type).set_blink_flag(t.node_id,!!t.is_need_alarm):this._rules_map.get(t.smart_type).set_blink_flag(t.node_id,!0))}catch(e){this.LOG.ERROR(e)}}else this.LOG.ERROR("not supported type result: "+t.smart_type)}start(){this._drawCtx.set_workcb(re()(this._draw.bind(this),40)),this._drawCtx.start(),this.drop_everything=!1}async input_rawbytes(e,t){if(!this._mask||this.drop_everything)return;this._hasStart||(this.start(),this._hasStart=!0);let r=performance.now(),i=new DataView(t),s=e.frameType,n=36,a=[];for(let t=0;t<e.smart.ivs_node_num;t++){let e,t=this._decoder.decode_node(i,n);t&&(n+=20,e=7==t.type&&28==s?await this._decoder.ivs_face_result(i,n):9==t.type&&28==s?await this._decoder.ivs_plate_result(i,n):100==t.type?await this._decoder.ivs_traffic_result(i,n):this._decoder.decode_data(s,t.type,t.version,i,n),n+=t.datalen,"{}"==JSON.stringify(e)&&19!=t.type||(e.smart_type=t.type,e.node_id=t.id,e.node_version=t.version,a.push(e)))}let o=performance.now();if(e.is_smart_i)this.set_smart_rule({header:e,frameData:a,decoded_end:o-r});else{let t=[],r=[],i=[];if(a.length>0){for(let e of a)100!=e.node_version&&200!=e.node_version&&205!=e.node_version&&206!=e.node_version||7!=e.smart_type?201==e.node_version&&7==e.smart_type||(100==e.smart_type?t.push(e):i.push(e)):r.push(e);t.length>0&&this._ob.emit("parsed_smartframe_facecomparison_result",{header:e,frameData:t,name:this._ob.config.name,uid:this._ob.uid}),r.length>0&&this._ob.emit("parsed_smartframe_facecapture_result",{header:e,frameData:r,name:this._ob.config.name,uid:this._ob.uid}),this.set_smart_result({header:e,frameData:i})}}}stop(){this._drawCtx.set_workcb(null),this._drawCtx.stop(),this.canvas_s&&this.canvas_s.Restore(),this._hasStart=!1,this.drop_everything=!0}destroy(){this.stop(),this._decoder=null,this._results_map=null,this._rules_map=null,this._mask=null,this.canvas_s.Destroy(),this.canvas_s=null}_draw(){if(this.canvas_s&&!this.drop_everything){this.canvas_s.Restore();for(let[e,t]of this._rules_map)t.draw();for(let[e,t]of this._results_map)t.draw({draw_extrainfo:this._draw_extrainfo});this.tempMapArea&&this.canvas_s.DrawTempMapArea&&this.canvas_s.DrawTempMapArea(this.tempMapArea)}}attach(e,t="smart"){if(e){if(this.LOG.WARN("[smart]",`mask:{w:${e.clientWidth} h:${e.clientHeight}},if w == h == 0,that means a fault just happened and you see nothing smart rules/results!`),e.clientWidth>0&&e.clientHeight>0)if(this._mask=e,this.stop(),"smart"==t){this.canvas_s=new CVCanvasDraw.SmartRuleAndResultShow(this._mask.clientWidth,this._mask.clientHeight,this._mask),this.canvas_s.bgColor="rgba(0,0,0,0)",this.canvas_s.Init();for(let[e,t]of this._rules_map)t.attach(this.canvas_s);for(let[e,t]of this._results_map)t.attach(this.canvas_s)}else"3dposition"==t&&(this.canvas_s=new CVCanvasDraw.Live3d_PrivacyMask(this._mask.clientWidth,this._mask.clientHeight,this._mask,this._ob),this.canvas_s.bgColor="rgba(0,0,0,0)",this.canvas_s.Init())}else this._mask=null,this.stop(),this.canvas_s&&(this.canvas_s.Destroy(),this.canvas_s=null)}};v.install("smart-parser",(function(){let e=this,t=v.LOG;if(!this.config.use_smart)return void t.WARN("禁用smartparser!!");f(this,"smartdecoder",new ie(this));const r=({header:e,chunk:t})=>{this.smartdecoder.input_rawbytes(e,t)};e.on("ws_data_incoming_smart",r),e.get_smartconfig=()=>({rule:this.smartdecoder._enable_smartrule,result:this.smartdecoder._enable_smartresult,enbale_faceonly:this.smartdecoder._startegy_faceonly,draw_extrainfo:this.smartdecoder._draw_extrainfo}),e.set_smartconfig=e=>{t.WARN(JSON.stringify(e)),e.hasOwnProperty("rule")&&(this.smartdecoder._enable_smartrule=e.rule),e.hasOwnProperty("result")&&(this.smartdecoder._enable_smartresult=e.result),e.hasOwnProperty("enbale_faceonly")&&(this.smartdecoder._startegy_faceonly=e.enbale_faceonly),e.hasOwnProperty("draw_extrainfo")&&(this.smartdecoder._draw_extrainfo=e.draw_extrainfo)};const i=e=>{this.smartdecoder&&this.smartdecoder.attach(e)};e.on("smartdecoder_attach",i);const s=()=>{this.smartdecoder&&this.smartdecoder.stop()};e.on("abort_request",s);const n=()=>{this.smartdecoder&&this.smartdecoder.start()};e.on("open_request",n);const a=({show:e})=>{this.smartdecoder.drop_everthing=!e};e.on("player_activate_status_changed",a),e.get_tempmaparea=()=>this.smartdecoder.tempMapArea,e.set_tempmaparea=e=>{t.WARN(JSON.stringify(e)),this.smartdecoder.tempMapArea=e};const o=()=>{e.off("ws_data_incoming_smart",r),e.off("smartdecoder_attach",i),e.off("abort_request",s),e.off("open_request",n),e.off("player_activate_status_changed",a),this.smartdecoder.stop(),this.smartdecoder.destroy(),this.smartdecoder=null,e.off("destroy",o)};e.on("destroy",o)}),["ws-loader"]);var se=function(){var e=function(){};function t(t){this.converter=t.converter,this.data=t.path||t.data,this.imageData=[],this.multiplier=t.multiplier||1,this.padding=t.padding||0,this.fps=t.fps||25,this.stepsPerFrame=~~t.stepsPerFrame||1,this.trailLength=t.trailLength||1,this.pointDistance=t.pointDistance||.05,this.domClass=t.domClass||"sonic",this.dom=t.dom||null,this.backgroundColor=t.backgroundColor||"rgba(0,0,0,0)",this.fillColor=t.fillColor,this.strokeColor=t.strokeColor,this.stepMethod="string"==typeof t.step?n[t.step]:t.step||n.square,this._setup=t.setup||e,this._teardown=t.teardown||e,this._preStep=t.preStep||e,this.pixelRatio=t.pixelRatio||null,this.width=t.width,this.height=t.height,this.fullWidth=this.width+2*this.padding,this.fullHeight=this.height+2*this.padding,this.domClass=t.domClass||"sonic",this.setup(this.dom)}var r=t.argTypes={DIM:1,DEGREE:2,RADIUS:3,OTHER:0},i=t.argSignatures={arc:[1,1,3,2,2,0],bezier:[1,1,1,1,1,1,1,1],line:[1,1,1,1]},s=t.pathMethods={bezier:function(e,t,r,i,s,n,a,o,l){var c=1-(e=1-e),h=e*e,d=c*c,u=h*e,_=3*h*c,f=3*e*d,m=d*c;return[u*t+_*n+f*o+m*i,u*r+_*a+f*l+m*s]},arc:function(e,t,r,i,s,n){var a=(n-s)*e+s,o=[Math.cos(a)*i+t,Math.sin(a)*i+r];return o.angle=a,o.t=e,o},line:function(e,t,r,i,s){return[(i-t)*e+t,(s-r)*e+r]}},n=t.stepMethods={square:function(e,t,r,i,s){this._.fillRect(e.x-3,e.y-3,6,6)},fader:function(e,t,r,i,s){this._.beginPath(),this._last&&this._.moveTo(this._last.x,this._last.y),this._.lineTo(e.x,e.y),this._.closePath(),this._.stroke(),this._last=e}};return t.prototype={calculatePixelRatio:function(){return(window.devicePixelRatio||1)/(this._.webkitBackingStorePixelRatio||this._.mozBackingStorePixelRatio||this._.msBackingStorePixelRatio||this._.oBackingStorePixelRatio||this._.backingStorePixelRatio||1)},setup:function(e=null){var t,n,a,o,l=this.data;this.canvas=e||document.createElement("canvas"),this._=this.canvas.getContext("2d"),null==this.pixelRatio&&(this.pixelRatio=this.calculatePixelRatio()),this.canvas.className=this.domClass,1!=this.pixelRatio?(this.canvas.style.height=this.fullHeight+"px",this.canvas.style.width=this.fullWidth+"px",this.fullHeight*=this.pixelRatio,this.fullWidth*=this.pixelRatio,this.canvas.height=this.fullHeight,this.canvas.width=this.fullWidth,this._.scale(this.pixelRatio,this.pixelRatio)):(this.canvas.height=this.fullHeight,this.canvas.width=this.fullWidth),this.points=[];for(var c=-1,h=l.length;++c<h;){if(t=l[c].slice(1),(a=l[c][0])in i)for(var d=-1,u=t.length;++d<u;){switch(n=i[a][d],o=t[d],n){case r.RADIUS:o*=this.multiplier;break;case r.DIM:o*=this.multiplier,o+=this.padding;break;case r.DEGREE:o*=Math.PI/180}t[d]=o}t.unshift(0);for(var _,f=this.pointDistance,m=f;m<=1;m+=f)m=Math.round(1*m/f)/(1/f),t[0]=m,_=s[a].apply(null,t),this.points.push({x:_[0],y:_[1],progress:m})}this.frame=0,this.converter&&this.converter.setup&&this.converter.setup(this)},prep:function(e){if(!(e in this.imageData)){this._.clearRect(0,0,this.fullWidth,this.fullHeight),this._.fillStyle=this.backgroundColor,this._.fillRect(0,0,this.fullWidth,this.fullHeight);var t,r,i,s,n=this.points,a=n.length;this.pointDistance;this._setup();for(var o=-1,l=a*this.trailLength;++o<l&&!this.stopped;)(t=n[r=e+o]||n[r-a])&&(this.alpha=Math.round(o/(l-1)*1e3)/1e3,this._.globalAlpha=this.alpha,this.fillColor&&(this._.fillStyle=this.fillColor),this.strokeColor&&(this._.strokeStyle=this.strokeColor),i=e/(this.points.length-1),s=o/(l-1),this._preStep(t,s,i),this.stepMethod(t,s,i));return this._teardown(),this.imageData[e]=this._.getImageData(0,0,this.fullWidth,this.fullWidth),!0}},draw:function(){this.prep(this.frame)||(this._.clearRect(0,0,this.fullWidth,this.fullWidth),this._.putImageData(this.imageData[this.frame],0,0)),this.converter&&this.converter.step&&this.converter.step(this),this.iterateFrame()||this.converter&&this.converter.teardown&&(this.converter.teardown(this),this.converter=null)},iterateFrame:function(){return this.frame+=this.stepsPerFrame,!(this.frame>=this.points.length)||(this.frame=0,!1)},play:function(){this.stopped||this.stop(),this.stopped=!1;var e=this;this.timer=setInterval((function(){e.draw()}),1e3/this.fps)},stop:function(){this.stopped=!0,this.timer&&clearInterval(this.timer)}},window.Sonic=t}();v.install("loading",(function(){let e=this;v.LOG;f(this,"_loadingObj",null);const t=({show:t})=>{if(!this._loadingObj){let t=d("canvas","loading-"+this.config.name,"\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                margin-top: -50px;\n                margin-left: -50px;\n                width: 100px;\n                height: 100px;\n                z-index: 1000;\n             ");e.rootElement.children[0].appendChild(t),this._loadingObj=new se({dom:t,width:100,height:100,padding:50,strokeColor:"#aaa",pointDistance:.01,stepsPerFrame:3,trailLength:.7,step:"fader",setup:function(){this._.lineWidth=10},path:[["arc",50,50,50,0,360]]})}t?(this._loadingObj.canvas.style.display="block",this._loadingObj.play()):(this._loadingObj.stop(),this._loadingObj.canvas.style.display="none")};e.on("loading_tips",t);const r=()=>{e.off("loading_tips",t),this._loadingObj&&(this._loadingObj.stop(),this._loadingObj=null),e.off("destroy",r)};e.on("destroy",r)}),["ws-loader"]);const ne={IDLE:"STOP",PLAY:"PLAY",PAUSE:"PAUSE",FAST:"FAST",SLOW:"SLOW",FRAME:"FRAME"};v.install("vod",(function(){let e=this;v.LOG;if(!e.config.vod)return;v.PlayerStatus=ne,f(e,"speed",0),f(e,"status",ne.IDLE);const t=t=>{e._ws.send(JSON.stringify(t))},r=t=>{e.status=t,e.emit("player_status_msg",{status:e.status})};e.play=i=>{if(e.status==ne.IDLE||e.status==ne.PLAY||e.status==ne.FAST||e.status==ne.SLOW){if(!i)return void e.emit("invalid_cinfo");e.logParams.cinfo=i,e.emit("open_request",i),e.speed=0}else if(e.status==ne.PAUSE)t({Type:1,Ch:0,Dev:0,Data:{Cmd:2}});else{if(e.status!=ne.FRAME)return;t({Type:1,Ch:0,Dev:0,Data:{Cmd:0}})}r(ne.PLAY)},e.stop=()=>{var t;e.status!=ne.IDLE&&(e.status==ne.PAUSE||e.status,e.emit("abort_request"),r(ne.IDLE),t=!1,e.volumne=t?1:0,e.emit("player_status_msg",{voice_status:t}))},e.pause=()=>{e.status!=ne.PLAY&&e.status!=ne.FAST&&e.status!=ne.SLOW||(t({Type:1,Ch:0,Dev:0,Data:{Cmd:2}}),r(ne.PAUSE))},e.frame=()=>{e.status!=ne.PLAY&&e.status!=ne.FAST&&e.status!=ne.SLOW||(t({Type:1,Ch:0,Dev:0,Data:{Cmd:4}}),r(ne.FRAME))},e.fast=()=>{},e.slow=()=>{};const i=()=>{e.off("destroy",i)};e.on("destroy",i)}),["ws-loader","base-decoder"]);v.install("stream-info",(function(){let e=this;v.LOG;[{obj:this,k:"streaminfo",v:{video:{fps:0,delay:0,testavr:new p(50)},audio:{fps:0,testavr:new p(50)}}}].forEach(({obj:e,k:t,v:r})=>{f(e,t,r)});const t=e=>{"video"==e.type?(this.streaminfo.video.testavr.test_fps(),e.is_key_frame&&(this.streaminfo.video.fps=this.streaminfo.video.testavr.get_avrfps())):"audio"==e.type&&(this.streaminfo.audio.testavr.test_fps(),e.is_key_frame&&(this.streaminfo.audio.fps=this.streaminfo.audio.testavr.get_avrfps()))};e.on("streaminfo_inputtick",t);const r=({delay:e,videoframes:t,pts_adjust_val:r})=>{this.streaminfo.video.delay=e,this.streaminfo.video.videoframes=t,this.streaminfo.video.pts_adjust_val=r};e.on("mse_render_info",r);const i=()=>{e.off("mse_render_info",r),e.off("streaminfo_inputtick",t),e.off("destroy",i)};e.on("destroy",i)}),["ws-loader"]);v.install("audio2wav",(function(){let e=this;e.transaudio2wav=e=>{let t=new Uint8Array(e);return this.FfmpegDecoder.worker.dispatch({type:"Audio2wav",content:t},[t.buffer]).then(e=>Promise.resolve(e.ab))};const t=()=>{e.off("destroy",t)};e.on("destroy",t)}),["base-decoder"]);r(35);var ae=class{constructor(e){this.ob=e,this.LOG=v.LOG,this.debug=!1,this._recorder=null}async start(e="wav",t=8e3,r=1024,i=16){if(this._recorder)return void this.LOG.ERROR("[voicetalk]","Audio Recorder is start already, ignore the start request!");let s=null,n=new ArrayBuffer(640),a=0,o=new DataView(n);this._recorder=Recorder({type:e,sampleRate:t,bufferSize:r,bitRate:i,onProcess:(e,t,r,i,n,l)=>{let c=Recorder.SampleData(e,i,8e3,s);for(let e=s?s.index:0;e<c.index;e++)this._recorder.buffers[e]=null;s=c;let h=s.data,d=0,u=h.length;for(;d<u;){let e=h[d];a<640||(this.ob.emit("audiodata_record",o.buffer),o=new DataView(new ArrayBuffer(640)),a=0),o.setInt16(a,e,!0),d++,a+=2}}}),await new Promise((e,t)=>{this._recorder.open(()=>{this._recorder.start()},(e,t)=>{this.LOG.ERROR("[voicetalk]",(t?"UserNotAllow，":"")+"无法录音:"+e)})})}async stop(){await new Promise((e,t)=>{this._recorder.stop((e,t)=>{if(this._recorder.close(),this._recorder=null,this.debug){this.LOG.DEBUG("[voicetalk]",((window.URL||webkitURL).createObjectURL(e),"时长:"+t+"ms"));let r=document.createElement("audio");r.controls=!0,document.body.appendChild(r),r.src=(window.URL||webkitURL).createObjectURL(e),r.play()}},e=>{this.LOG.ERROR("[voicetalk]","录音失败:"+e),this._recorder.close(),this._recorder=null})})}};var oe=class{constructor(){l()(this),this.LOG=v.LOG,this.pcmframe_list=[]}destroy(){this.stop_record()}_feed_pcm16_to_encode(){if(0==this.pcmframe_list.length);else{let e=this.pcmframe_list.shift(),t=W.g711_encode(new Uint16Array(e),W.G711_TYPE.TP_ULAW);t.byteLength>0&&this.emit("audiodata_record_encode_to_g711u",t)}}_input_pcm16data(e){this.pcmframe_list.push(e),this._feed_pcm16_to_encode()}stop(){this.$recorder&&(this.off("audiodata_record",this._input_pcm16data),this.$recorder.stop())}start_record_push(){return this.$recorder||(this.$recorder=new ae(this)),this.on("audiodata_record",this._input_pcm16data),this.$recorder.start(),!0}};window.CV={H5:{live:{players:[],uid:0},vod:{players:[],uid:0}}},document.addEventListener("visibilitychange",(function(){let e=document.hidden;["live","vod"].forEach(t=>{CV.H5[t].players.forEach(t=>{t.emit("player_activate_status_changed",{isHidden:e})})})}));t.default={Events:{PLAYER_READY:"player_ready",PLAYER_STREAM_OPENED:"player_stream_opened",PLAYER_STREAM_CLOSED:"player_stream_closed",PLAYER_DETECT_VIDEO_CODECID_CHANGED:"player_detect_codec_changed",PLAYER_STREAM_INFO:"player_stream_info",PARSED_SMARTFRAME_FACECOMPARISON_RESULT:"parsed_smartframe_facecomparison_result",PARSED_SMARTFRAME_FACECAPTURE_RESULT:"parsed_smartframe_facecapture_result",AUDIODATA_RECORD_ENCODE_TO_G711U:"audiodata_record_encode_to_g711u",PLAYER_CURRENT_UTCTIME:"player_current_utctime",PLAYER_STATUS_MSG:"player_status_msg",PLAYER_NO_ANYDECODER_FOUNDED:"no_any_decoders_founded",PLAYER_NO_MSE_DECODER_FOUNDED:"no_mse_decoder_founded",PLAYER_NO_CV_DECODER_FOUNDED:"no_cv_decoder_founded"},PlayerStatus:v.PlayerStatus,CreateLivePlayer:function(e={}){let{name:t,render_type:r,use_smart:i,el:s,reconnect:n}=e,a=new v({name:0==t.length?uuid:t,el:s,render_type:r,use_smart:i,reconnect:n});return CV.H5.live.players.push(a),a.uid="live-"+CV.H5.live.uid++,a},CreateVodPlayer:function(e){let{name:t,render_type:r,use_smart:i,el:s,reconnect:n}=e,a=new v({name:0==t.length?uuid:t,el:s,render_type:r,vod:!0,use_smart:!1,reconnect:n});return CV.H5.vod.players.push(a),a.uid="vod-"+CV.H5.vod.uid++,a},Recycle:function(e){["live","vod"].forEach(t=>{let r=CV.H5[t].players.findIndex(t=>t.uid==e.uid);-1!=r&&CV.H5[t].players.splice(r,1)})},CreateVoiceRecorder:function(){let e=null;return e?v.LOG.ERROR("RecordMediaStreamToIPC can only be inited once! "):e=new oe({name:"RecordMediaStreamToIPC"}),e},RenderType:{MSE:"MSE",FFMPEG:"FFMPEG",AUTO:"AUTO"}}}]).default}));
//# sourceMappingURL=h5player.js.map